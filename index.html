<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="肥料の含有率と使用量から各栄養素の量を計算するツールです。">
    <title>肥料計算機</title>
    <!-- アクセシビリティ向上のためのフォーカススタイル -->
    <style id="accessibility-focus">
        *:focus {
            outline: 2px solid #3498db !important;
            outline-offset: 2px !important;
        }

        /* スキップナビゲーション */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #2c7744;
            color: white;
            padding: 8px;
            z-index: 100;
            transition: top 0.3s;
        }
        .skip-link:focus {
            top: 0;
        }

        /* スクリーンリーダー用に視覚的に隠す（だが読み上げ可能） */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* 高コントラストモード対応 */
        @media (forced-colors: active) {
            button, .tab, .preset-btn {
                border: 1px solid currentColor;
            }

            .tab.active {
                border: 2px solid currentColor;
            }
        }
    </style>
    <!-- ダークモード対応のためのCSS変数 -->
    <style id="theme-variables">
        :root {
            --color-bg-primary: #f8f9fa;
            --color-bg-secondary: #ffffff;
            --color-bg-tertiary: #e9f7ef;
            --color-bg-accent: #eaf2fa;
            --color-text-primary: #333;
            --color-text-secondary: #555;
            --color-text-muted: #777;
            --color-text-heading: #2c7744;
            --color-border: #ddd;
            --color-primary: #2c7744;
            --color-primary-hover: #1e5e30;
            --color-shadow: rgba(0, 0, 0, 0.1);
            --color-shadow-strong: rgba(0, 0, 0, 0.2);
            --color-preset: #3498db;
            --color-preset-hover: #2980b9;
            --color-error: #e74c3c;
            --color-error-bg: #ffecec;
            --color-warning: #f39c12;
            --color-warning-hover: #e67e22;
            --color-success: #27ae60;
            --color-success-hover: #219955;
            --color-cancel: #95a5a6;
            --color-cancel-hover: #7f8c8d;
            --color-history: #9b59b6;
            --color-history-hover: #8e44ad;
            --color-table-header: #e6f0e9;
            --color-table-hover: #f5f9ff;
        }

        body.dark-mode {
            --color-bg-primary: #121212;
            --color-bg-secondary: #1e1e1e;
            --color-bg-tertiary: #1a3028;
            --color-bg-accent: #1e2a38;
            --color-text-primary: #e0e0e0;
            --color-text-secondary: #b0b0b0;
            --color-text-muted: #909090;
            --color-text-heading: #4caf50;
            --color-border: #333;
            --color-primary: #4caf50;
            --color-primary-hover: #388e3c;
            --color-shadow: rgba(0, 0, 0, 0.3);
            --color-shadow-strong: rgba(0, 0, 0, 0.4);
            --color-preset: #2196f3;
            --color-preset-hover: #1976d2;
            --color-error: #f44336;
            --color-error-bg: #2d1a1a;
            --color-warning: #ff9800;
            --color-warning-hover: #f57c00;
            --color-success: #2ecc71;
            --color-success-hover: #27ae60;
            --color-cancel: #607d8b;
            --color-cancel-hover: #455a64;
            --color-history: #9c27b0;
            --color-history-hover: #7b1fa2;
            --color-table-header: #1a372a;
            --color-table-hover: #1e2a38;
        }
    </style>

    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--color-text-primary);
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--color-bg-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        h1 {
            color: var(--color-text-heading);
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 1px 1px 3px var(--color-shadow);
        }
        .container {
            background-color: var(--color-bg-secondary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 3px 15px var(--color-shadow);
            transition: box-shadow 0.3s ease, background-color 0.3s ease;
        }
        .container:hover {
            box-shadow: 0 5px 20px var(--color-shadow-strong);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            transition: color 0.2s ease;
            color: var(--color-text-primary);
        }
        label:hover {
            color: var(--color-primary);
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            box-sizing: border-box;
            transition: all 0.2s ease-in-out;
            background-color: var(--color-bg-secondary);
            color: var(--color-text-primary);
        }
        input:hover, select:hover {
            border-color: var(--color-preset);
        }
        input:focus, select:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 5px var(--color-primary);
            outline: none;
        }
        button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px var(--color-shadow);
            position: relative;
            overflow: hidden;
        }
        button:hover {
            background-color: var(--color-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--color-shadow-strong);
        }
        button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px var(--color-shadow);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9em;
            box-shadow: 0 2px 10px var(--color-shadow);
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--color-bg-secondary);
        }
        th, td {
            border: 1px solid var(--color-border);
            padding: 8px;
            text-align: left;
            transition: background-color 0.2s ease;
        }
        tr:hover td {
            background-color: var(--color-table-hover);
        }
        th {
            background-color: var(--color-table-header);
            color: var(--color-text-heading);
            position: sticky;
            top: 0;
            box-shadow: 0 1px 2px var(--color-shadow);
        }
        .results {
            margin-top: 30px;
            padding: 15px;
            background-color: var(--color-bg-tertiary);
            border-radius: 8px;
            box-shadow: 0 3px 10px var(--color-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease;
        }
        .results:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--color-shadow-strong);
        }
        .results h2 {
            color: var(--color-text-heading);
            margin-top: 0;
            text-shadow: 1px 1px 2px var(--color-shadow);
        }
        .control-buttons {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
        }
        .control-buttons-left {
            display: flex;
            gap: 10px;
        }
        .control-buttons-right {
            display: flex;
            gap: 10px;
        }
        .delete-btn {
            background-color: var(--color-error);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px var(--color-shadow);
        }
        .delete-btn:hover {
            background-color: var(--color-error);
            filter: brightness(0.9);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px var(--color-shadow-strong);
        }
        .delete-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px var(--color-shadow);
        }
        .fertilizer-presets {
            margin-bottom: 20px;
        }
        .preset-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .preset-btn {
            background-color: var(--color-preset);
            font-size: 14px;
            transition: all 0.25s ease;
            transform-origin: center;
            box-shadow: 0 2px 4px var(--color-shadow);
        }
        .preset-btn:hover {
            background-color: var(--color-preset-hover);
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 4px 8px var(--color-shadow-strong);
        }
        .preset-btn:active {
            transform: translateY(1px) scale(0.98);
            box-shadow: 0 1px 2px var(--color-shadow);
        }

        /* ダークモード切り替えボタン */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            box-shadow: 0 2px 5px var(--color-shadow);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: rotate(30deg);
            box-shadow: 0 2px 8px var(--color-shadow-strong);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .form-grid .form-group:nth-child(1),
        .form-grid .form-group:nth-child(5) {
            grid-column: 1 / -1;
        }
        .toggle-section {
            cursor: pointer;
            color: var(--color-preset);
            font-weight: bold;
            margin: 15px 0;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.2s ease;
            background-color: var(--color-bg-accent);
            display: inline-block;
        }
        .toggle-section:hover {
            background-color: var(--color-bg-accent);
            filter: brightness(0.95);
            box-shadow: 0 2px 5px var(--color-shadow);
            transform: translateY(-1px);
        }
        .toggle-section:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        #advancedFields {
            display: none;
            border-top: 1px dashed var(--color-border);
            padding-top: 15px;
            margin-top: 15px;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 5px var(--color-shadow);
        }
        .tab {
            padding: 12px 20px;
            background-color: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
            flex-grow: 1;
            text-align: center;
            font-weight: 500;
        }
        .tab:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-primary);
            opacity: 0.1;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: -1;
        }
        .tab:hover:before {
            transform: translateY(0);
        }
        .tab.active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
            box-shadow: 0 2px 5px var(--color-shadow-strong);
            transform: translateY(-2px);
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        .tab-content.active {
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal.show {
            opacity: 1;
        }
        .modal-content {
            background-color: var(--color-bg-secondary);
            color: var(--color-text-primary);
            margin: 50px auto;
            padding: 25px;
            width: 80%;
            max-width: 700px;
            border-radius: 8px;
            box-shadow: 0 10px 30px var(--color-shadow-strong);
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(-30px);
            opacity: 0;
            transition: all 0.4s ease;
        }
        .modal.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .close-modal:hover {
            color: #555;
            background-color: #f5f5f5;
            transform: rotate(90deg);
        }
        .preset-settings {
            margin-top: 20px;
        }
        .preset-settings table {
            margin-bottom: 20px;
        }
        .preset-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .preset-actions button {
            margin-right: 5px;
        }
        .preset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            transition: all 0.2s ease;
            border-radius: 4px;
        }
        .preset-item:hover {
            background-color: #f9f9f9;
            transform: translateX(2px);
        }
        .preset-item:last-child {
            border-bottom: none;
        }
        .preset-item-actions {
            display: flex;
            gap: 5px;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .checkbox-label:hover {
            background-color: #f0f0f0;
        }
        .checkbox-label input {
            width: auto;
            margin-right: 8px;
            transform: scale(1.2);
            transition: all 0.2s ease;
        }
        .checkbox-label:hover input {
            transform: scale(1.3);
        }
        .manage-presets-btn {
            background-color: var(--color-warning);
            margin-left: auto;
            display: block;
            position: relative;
            overflow: hidden;
        }
        .manage-presets-btn:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        .manage-presets-btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        @keyframes ripple {
            0% { transform: scale(0, 0); opacity: 0.5; }
            20% { transform: scale(25, 25); opacity: 0.3; }
            100% { opacity: 0; transform: scale(40, 40); }
        }
        .manage-presets-btn:hover {
            background-color: var(--color-warning-hover);
        }
        .add-preset-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid var(--color-border);
            animation: fadeIn 0.5s ease;
        }
        .save-btn {
            background-color: var(--color-success);
            position: relative;
            overflow: hidden;
        }
        .save-btn:hover {
            background-color: var(--color-success-hover);
        }
        .save-btn:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255,255,255,0.2), rgba(255,255,255,0));
            transform: translateY(-100%);
        }
        .save-btn:hover:after {
            transform: translateY(0);
            transition: transform 0.3s ease;
        }
        .cancel-btn {
            background-color: var(--color-cancel);
        }
        .cancel-btn:hover {
            background-color: var(--color-cancel-hover);
        }
        .button-spacer {
            margin-top: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        .add-fertilizer-btn {
            background-color: var(--color-primary);
            font-size: 18px;
            padding: 12px 25px;
            margin: 0 auto;
            display: block;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 10px var(--color-shadow);
            transition: all 0.3s ease;
        }
        .add-fertilizer-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px var(--color-shadow-strong);
            background-color: var(--color-primary-hover);
        }
        .add-fertilizer-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px var(--color-shadow);
        }
        .default-preset-item {
            opacity: 0.85;
            transition: opacity 0.2s ease;
        }
        .default-preset-item:hover {
            opacity: 1;
        }
        .preset-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--color-border);
        }
        .history-btn {
            background-color: var(--color-history);
        }
        .history-btn:hover {
            background-color: var(--color-history-hover);
        }
        .history-item {
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 2px 5px var(--color-shadow);
            background-color: var(--color-bg-secondary);
        }
        .history-item:hover {
            background-color: var(--color-table-hover);
            transform: translateY(-3px) scale(1.01);
            box-shadow: 0 5px 15px var(--color-shadow-strong);
            border-color: var(--color-preset);
        }
        .history-item h4 {
            margin-top: 0;
            color: var(--color-text-heading);
            transition: color 0.2s ease;
        }
        .history-item:hover h4 {
            color: var(--color-preset);
        }
        .history-item .npk-ratio {
            font-weight: bold;
            color: var(--color-text-primary);
            transition: all 0.2s ease;
        }
        .history-item:hover .npk-ratio {
            color: var(--color-primary);
            transform: scale(1.05);
        }
        .history-item .timestamp {
            color: var(--color-text-muted);
            font-size: 0.9em;
            text-align: right;
            margin-top: 10px;
        }
        .history-empty {
            text-align: center;
            color: var(--color-text-muted);
            font-style: italic;
            padding: 30px;
            background-color: var(--color-bg-secondary);
            border-radius: 8px;
            animation: pulse 2s infinite ease-in-out;
        }
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* スワイプヒント */
        .mobile-swipe-hint {
            display: none;
            text-align: center;
            color: var(--color-text-muted);
            font-style: italic;
            margin-top: 5px;
            animation: pulse 2s infinite;
        }

        /* テーブルのレスポンシブ対応 */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* iOSでのスムーズスクロール */
            position: relative;
        }

        /* レスポンシブデザイン用のメディアクエリ */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 6px;
            }

            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .tabs {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .tab {
                padding: 10px;
                font-size: 14px;
                flex-grow: 1;
                min-width: 80px;
                min-height: 44px; /* タッチ領域の最小高さ */
            }

            .preset-container {
                flex-wrap: wrap;
            }

            .preset-btn {
                font-size: 12px;
                padding: 8px 10px;
                margin-bottom: 5px;
                flex-grow: 1;
                min-width: 100px;
                min-height: 44px; /* タッチしやすく */
            }

            button {
                min-height: 44px; /* タッチ領域の最小高さ */
            }

            input, select {
                min-height: 44px; /* タッチ領域の最小高さ */
                font-size: 16px; /* iOSでズームしないための最小フォントサイズ */
            }

            /* モーダルのサイズ調整 */
            .modal-content {
                width: 95%;
                padding: 15px;
                margin: 20px auto;
                max-height: 80vh;
            }

            /* ダークモードトグルボタンの位置調整 */
            .theme-toggle {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }

            /* 履歴項目の調整 */
            .history-item {
                padding: 10px;
            }

            .history-item h4 {
                font-size: 16px;
            }

            .control-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .control-buttons-left,
            .control-buttons-right {
                width: 100%;
                justify-content: center;
            }

            /* テーブルのスクロール対応 */
            table {
                min-width: 600px; /* テーブルの最小幅を設定 */
            }

            .mobile-swipe-hint {
                display: block; /* モバイルでのみ表示 */
                margin-bottom: 10px;
            }

            /* ラベルをタップしやすく */
            label {
                padding: 3px 0;
                margin-bottom: 8px;
            }

        }

        /* さらに小さい画面用の調整 */
        @media screen and (max-width: 480px) {
            h1 {
                font-size: 24px;
                margin-bottom: 15px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
                margin-bottom: 15px;
            }

            .tab {
                border-radius: 0;
                margin-bottom: 1px;
                padding: 10px;
                font-size: 16px;
            }

            .tab:first-child {
                border-radius: 4px 4px 0 0;
            }

            .tab:last-child {
                border-radius: 0 0 4px 4px;
            }

            button {
                padding: 12px 15px;
                font-size: 16px;
                width: 100%;
                margin: 5px 0;
            }

            .control-buttons button {
                margin-right: 0;
            }

            .preset-btn {
                width: 100%;
                margin-right: 0;
                padding: 12px 10px;
                font-size: 16px;
                text-align: left;
            }

            .preset-container {
                flex-direction: column;
                gap: 8px;
            }

            /* テーブルのスマホ表示 */
            table {
                min-width: 480px; /* スマホの横幅に合わせて調整 */
                font-size: 14px;
            }

            th, td {
                padding: 6px 4px;
            }

            /* モーダルの最大高さを調整 */
            .modal-content {
                max-height: 90vh;
                width: 90%;
                padding: 15px 10px;
            }

            /* モーダル内フォームの調整 */
            .add-preset-section .form-grid {
                grid-template-columns: 1fr;
            }

            /* 肥料追加ボタンのサイズ調整 */
            .add-fertilizer-btn {
                width: 100%;
                font-size: 18px;
                padding: 15px;
            }

            /* フォーム要素のタッチ領域拡大 */
            input, select, button {
                touch-action: manipulation; /* ダブルタップによるズームを防止 */
            }

            /* 入力フォームの余白調整 */
            .form-group {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- スキップナビゲーション -->
    <a href="#main-content" class="skip-link">メインコンテンツへスキップ</a>

    <!-- ダークモード切り替え -->
    <button class="theme-toggle" id="themeToggle" aria-label="ダークモードとライトモードを切り替える">🌓</button>

    <div class="container" role="main" id="main-content">
        <h1>肥料計算機</h1>
        
        <div class="fertilizer-presets">
            <div class="preset-actions">
                <h3 id="presets-heading">肥料プリセット</h3>
                <button class="manage-presets-btn" onclick="openPresetsModal()" aria-label="プリセット管理画面を開く" aria-haspopup="dialog">プリセット管理</button>
            </div>
            <div id="userPresetContainer" class="preset-container" role="group" aria-labelledby="presets-heading">
                <!-- プリセットボタンはJavaScriptで生成されます -->
            </div>
        </div>

        <div class="form-section" role="form" aria-labelledby="form-heading">
            <h2 id="form-heading" class="visually-hidden">肥料情報入力フォーム</h2>

            <div class="form-group">
                <label for="fertilizerName">肥料名:</label>
                <input type="text" id="fertilizerName" placeholder="例: 硝酸カリ" aria-required="true">
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="nitrogenContent">窒素 (N) 含有率 (%):</label>
                    <input type="number" id="nitrogenContent" step="0.1" min="0" max="100" placeholder="例: 13.5" aria-required="true">
                </div>

                <div class="form-group">
                    <label for="phosphorusContent">リン酸 (P) 含有率 (%):</label>
                    <input type="number" id="phosphorusContent" step="0.1" min="0" max="100" placeholder="例: 0" aria-required="true">
                </div>

                <div class="form-group">
                    <label for="potassiumContent">カリウム (K) 含有率 (%):</label>
                    <input type="number" id="potassiumContent" step="0.1" min="0" max="100" placeholder="例: 46.3" aria-required="true">
                </div>
            </div>

            <button type="button" class="toggle-section" onclick="toggleAdvancedFields()" aria-expanded="false" aria-controls="advancedFields">▼ 微量要素の入力（クリックで表示/非表示）</button>
            
            <div id="advancedFields" aria-labelledby="advanced-heading">
                <h3 id="advanced-heading" class="visually-hidden">微量要素の入力</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="calciumContent">カルシウム (Ca) 含有率 (%):</label>
                        <input type="number" id="calciumContent" step="0.1" min="0" max="100" placeholder="例: 0" aria-describedby="ca-desc">
                        <span id="ca-desc" class="visually-hidden">カルシウム含有率をパーセントで入力してください</span>
                    </div>

                    <div class="form-group">
                        <label for="magnesiumContent">マグネシウム (Mg) 含有率 (%):</label>
                        <input type="number" id="magnesiumContent" step="0.1" min="0" max="100" placeholder="例: 0" aria-describedby="mg-desc">
                        <span id="mg-desc" class="visually-hidden">マグネシウム含有率をパーセントで入力してください</span>
                    </div>

                    <div class="form-group">
                        <label for="sulfurContent">硫黄 (S) 含有率 (%):</label>
                        <input type="number" id="sulfurContent" step="0.1" min="0" max="100" placeholder="例: 0" aria-describedby="s-desc">
                        <span id="s-desc" class="visually-hidden">硫黄含有率をパーセントで入力してください</span>
                    </div>

                    <div class="form-group">
                        <label for="ironContent">鉄 (Fe) 含有率 (%):</label>
                        <input type="number" id="ironContent" step="0.01" min="0" max="100" placeholder="例: 0" aria-describedby="fe-desc">
                        <span id="fe-desc" class="visually-hidden">鉄含有率をパーセントで入力してください</span>
                    </div>

                    <div class="form-group">
                        <label for="manganeseContent">マンガン (Mn) 含有率 (%):</label>
                        <input type="number" id="manganeseContent" step="0.01" min="0" max="100" placeholder="例: 0" aria-describedby="mn-desc">
                        <span id="mn-desc" class="visually-hidden">マンガン含有率をパーセントで入力してください</span>
                    </div>

                    <div class="form-group">
                        <label for="zincContent">亜鉛 (Zn) 含有率 (%):</label>
                        <input type="number" id="zincContent" step="0.01" min="0" max="100" placeholder="例: 0" aria-describedby="zn-desc">
                        <span id="zn-desc" class="visually-hidden">亜鉛含有率をパーセントで入力してください</span>
                    </div>

                    <div class="form-group">
                        <label for="boronContent">ホウ素 (B) 含有率 (%):</label>
                        <input type="number" id="boronContent" step="0.01" min="0" max="100" placeholder="例: 0" aria-describedby="b-desc">
                        <span id="b-desc" class="visually-hidden">ホウ素含有率をパーセントで入力してください</span>
                    </div>

                    <div class="form-group">
                        <label for="otherContent">その他の要素 (任意):</label>
                        <input type="text" id="otherContent" placeholder="例: Cu 0.5%, Mo 0.1%" aria-describedby="other-desc">
                        <span id="other-desc" class="visually-hidden">その他の微量要素を入力してください（任意）</span>
                    </div>
                </div>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label for="amount">使用量:</label>
                <div style="display: flex; gap: 10px;" role="group" aria-labelledby="amount-group">
                    <span id="amount-group" class="visually-hidden">肥料の使用量と単位</span>
                    <input type="number" id="amount" step="0.1" min="0" placeholder="例: 100" style="flex: 3;" aria-required="true">
                    <select id="amountUnit" style="flex: 1;" aria-label="使用量の単位">
                        <option value="g">g</option>
                        <option value="kg">kg</option>
                    </select>
                </div>
            </div>

            <div class="button-spacer">
                <button class="add-fertilizer-btn" onclick="addFertilizer()" aria-label="現在入力している肥料データを追加する">肥料を追加</button>
            </div>
        </div>
        
        <div class="tabs" role="tablist" aria-label="肥料計算タブ">
            <button
                class="tab active"
                id="fertilizerTab-btn"
                onclick="switchTab('fertilizerTab')"
                role="tab"
                aria-selected="true"
                aria-controls="fertilizerTab">
                肥料リスト
            </button>
            <button
                class="tab"
                id="resultsTab-btn"
                onclick="switchTab('resultsTab')"
                role="tab"
                aria-selected="false"
                aria-controls="resultsTab">
                計算結果
            </button>
            <button
                class="tab"
                id="historyTab-btn"
                onclick="switchTab('historyTab')"
                role="tab"
                aria-selected="false"
                aria-controls="historyTab">
                計算履歴
            </button>
        </div>
        
        <div id="fertilizerTab" class="tab-content active" role="tabpanel" aria-labelledby="fertilizerTab-btn">
            <div class="fertilizers-list">
                <h3 id="fertilizers-heading">追加された肥料</h3>
                <div class="table-responsive">
                    <table id="fertilizerTable" aria-labelledby="fertilizers-heading">
                        <caption class="visually-hidden">追加された肥料の一覧</caption>
                        <thead>
                            <tr>
                                <th scope="col">肥料名</th>
                                <th scope="col">N (%)</th>
                                <th scope="col">P (%)</th>
                                <th scope="col">K (%)</th>
                                <th scope="col">Ca (%)</th>
                                <th scope="col">Mg (%)</th>
                                <th scope="col">S (%)</th>
                                <th scope="col">使用量</th>
                                <th scope="col">操作</th>
                            </tr>
                        </thead>
                        <tbody id="fertilizerList">
                            <!-- 肥料データがここに追加されます -->
                        </tbody>
                    </table>
                </div>
                <p class="mobile-swipe-hint">← 横にスワイプできます →</p>
            </div>
        </div>

        <div id="resultsTab" class="tab-content" role="tabpanel" aria-labelledby="resultsTab-btn" hidden>
            <div class="results" id="resultsSection">
                <h2 id="results-heading">計算結果</h2>
                <div id="calculationResults" aria-live="polite" aria-atomic="true">
                    <!-- 計算結果がここに表示されます -->
                    <p>まだ肥料が追加されていません</p>
                </div>
            </div>
        </div>

        <div id="historyTab" class="tab-content" role="tabpanel" aria-labelledby="historyTab-btn" hidden>
            <div class="results">
                <h2 id="history-heading">計算履歴</h2>
                <div id="historyList" aria-live="polite" aria-labelledby="history-heading">
                    <!-- 計算履歴がここに表示されます -->
                    <div class="history-empty" role="status">計算履歴はありません</div>
                </div>
            </div>
        </div>
        
        <div class="control-buttons">
            <div class="control-buttons-left">
                <button onclick="calculateResults()" aria-label="入力された肥料データから結果を計算する">結果を計算</button>
                <button class="history-btn" onclick="switchTab('historyTab')" aria-label="計算履歴タブに切り替える">履歴を表示</button>
            </div>
            <div class="control-buttons-right">
                <button onclick="resetCalculator()" style="background-color: #e74c3c;" aria-label="全てのデータをリセットする" aria-describedby="reset-desc">リセット</button>
                <span id="reset-desc" class="visually-hidden">警告：この操作は入力されたすべての肥料データを削除します</span>
            </div>
        </div>
    </div>

    <!-- プリセット管理モーダル -->
    <div id="presetsModal" class="modal" role="dialog" aria-labelledby="presets-modal-title" aria-modal="true" aria-hidden="true">
        <div class="modal-content">
            <button class="close-modal" onclick="closePresetsModal()" aria-label="プリセット管理画面を閉じる">&times;</button>
            <h2 id="presets-modal-title">プリセット管理</h2>
            
            <div class="preset-settings">
                <div class="preset-section">
                    <h3 id="default-presets-heading">デフォルトプリセット（表示/非表示の選択）</h3>
                    <div id="defaultPresetList" role="region" aria-labelledby="default-presets-heading">
                        <!-- デフォルトプリセットリストがここに表示されます -->
                    </div>
                </div>

                <div class="preset-section">
                    <h3 id="custom-presets-heading">カスタムプリセット（追加・削除可能）</h3>
                    <div id="userPresetList" role="region" aria-labelledby="custom-presets-heading">
                        <!-- ユーザープリセットリストがここに表示されます -->
                    </div>
                </div>

                <div class="add-preset-section">
                    <h3 id="add-preset-heading">新しいプリセットを追加</h3>
                    <div role="form" aria-labelledby="add-preset-heading">
                        <div class="form-group">
                            <label for="newPresetName">肥料名:</label>
                            <input type="text" id="newPresetName" placeholder="例: マイ肥料" aria-required="true">
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="newPresetN">窒素 (N) %:</label>
                                <input type="number" id="newPresetN" step="0.1" min="0" max="100" aria-required="true">
                            </div>

                            <div class="form-group">
                                <label for="newPresetP">リン酸 (P) %:</label>
                                <input type="number" id="newPresetP" step="0.1" min="0" max="100" aria-required="true">
                            </div>

                            <div class="form-group">
                                <label for="newPresetK">カリウム (K) %:</label>
                                <input type="number" id="newPresetK" step="0.1" min="0" max="100" aria-required="true">
                            </div>

                            <div class="form-group">
                                <label for="newPresetCa">カルシウム (Ca) %:</label>
                                <input type="number" id="newPresetCa" step="0.1" min="0" max="100">
                            </div>

                            <div class="form-group">
                                <label for="newPresetMg">マグネシウム (Mg) %:</label>
                                <input type="number" id="newPresetMg" step="0.1" min="0" max="100">
                            </div>

                            <div class="form-group">
                                <label for="newPresetS">硫黄 (S) %:</label>
                                <input type="number" id="newPresetS" step="0.1" min="0" max="100">
                            </div>

                            <div class="form-group">
                                <label for="newPresetFe">鉄 (Fe) %:</label>
                                <input type="number" id="newPresetFe" step="0.01" min="0" max="100">
                            </div>

                            <div class="form-group">
                                <label for="newPresetMn">マンガン (Mn) %:</label>
                                <input type="number" id="newPresetMn" step="0.01" min="0" max="100">
                            </div>

                            <div class="form-group">
                                <label for="newPresetZn">亜鉛 (Zn) %:</label>
                                <input type="number" id="newPresetZn" step="0.01" min="0" max="100">
                            </div>

                            <div class="form-group">
                                <label for="newPresetB">ホウ素 (B) %:</label>
                                <input type="number" id="newPresetB" step="0.01" min="0" max="100">
                            </div>
                        </div>

                        <button class="save-btn" onclick="addNewPreset()" aria-label="入力したデータで新しいプリセットを追加">プリセットを追加</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 肥料データを保存する配列
        let fertilizers = [];
        
        // 計算履歴を保存する配列
        let calculationHistory = [];
        
        // デフォルトプリセット
        const defaultPresets = [
            { id: 'd1', name: '硝酸カリ', nitrogen: 13.5, phosphorus: 0, potassium: 46.3, calcium: 0, magnesium: 0, sulfur: 0, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true },
            { id: 'd2', name: '硝酸アンモニウム', nitrogen: 34, phosphorus: 0, potassium: 0, calcium: 0, magnesium: 0, sulfur: 0, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true },
            { id: 'd3', name: '燐安', nitrogen: 18, phosphorus: 46, potassium: 0, calcium: 0, magnesium: 0, sulfur: 0, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true },
            { id: 'd4', name: '尿素', nitrogen: 46, phosphorus: 0, potassium: 0, calcium: 0, magnesium: 0, sulfur: 0, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true },
            { id: 'd5', name: '硫安', nitrogen: 21, phosphorus: 0, potassium: 0, calcium: 0, magnesium: 0, sulfur: 24, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true },
            { id: 'd6', name: '塩化カリ', nitrogen: 0, phosphorus: 0, potassium: 60, calcium: 0, magnesium: 0, sulfur: 0, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true },
            { id: 'd7', name: '硫酸カリ', nitrogen: 0, phosphorus: 0, potassium: 50, calcium: 0, magnesium: 0, sulfur: 18, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true },
            { id: 'd8', name: '過リン酸石灰', nitrogen: 0, phosphorus: 20, potassium: 0, calcium: 15, magnesium: 0, sulfur: 0, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true }
        ];
        
        // ユーザー定義プリセット
        let userPresets = [];
        
        // ページ読み込み時に設定を読み込む
        window.onload = function() {
            loadSettings();
            loadHistory();
            renderPresets();
            renderHistoryList();
        };
        
        // 設定をローカルストレージから読み込む
        function loadSettings() {
            // デフォルトプリセットの表示設定を読み込む
            const savedDefaultPresets = localStorage.getItem('defaultPresets');
            if (savedDefaultPresets) {
                const parsedDefaults = JSON.parse(savedDefaultPresets);
                
                // 既存のデフォルトプリセットの表示状態を更新
                defaultPresets.forEach(preset => {
                    const savedPreset = parsedDefaults.find(p => p.id === preset.id);
                    if (savedPreset) {
                        preset.isVisible = savedPreset.isVisible;
                    }
                });
            }
            
            // ユーザープリセットを読み込む
            const savedUserPresets = localStorage.getItem('userPresets');
            if (savedUserPresets) {
                userPresets = JSON.parse(savedUserPresets);
            }
        }
        
        // 計算履歴をローカルストレージから読み込む
        function loadHistory() {
            const savedHistory = localStorage.getItem('calculationHistory');
            if (savedHistory) {
                calculationHistory = JSON.parse(savedHistory);
            }
        }
        
        // 設定をローカルストレージに保存
        function saveSettings() {
            // デフォルトプリセットの表示設定を保存
            const defaultSettings = defaultPresets.map(preset => ({
                id: preset.id,
                isVisible: preset.isVisible
            }));
            localStorage.setItem('defaultPresets', JSON.stringify(defaultSettings));
            
            // ユーザープリセットを保存
            localStorage.setItem('userPresets', JSON.stringify(userPresets));
        }
        
        // 計算履歴をローカルストレージに保存
        function saveHistory() {
            localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));
        }
        
        // 計算結果を履歴に追加
        function addToHistory(result) {
            // 現在の日時を取得
            const now = new Date();
            const timestamp = now.toLocaleString('ja-JP');
            
            // 肥料リストのコピーを作成
            const fertilizersCopy = JSON.parse(JSON.stringify(fertilizers));
            
            // 履歴エントリーを作成
            const historyEntry = {
                id: Date.now(),
                timestamp: timestamp,
                result: result,
                fertilizers: fertilizersCopy
            };
            
            // 履歴の先頭に追加
            calculationHistory.unshift(historyEntry);
            
            // 履歴を10件に制限
            if (calculationHistory.length > 10) {
                calculationHistory = calculationHistory.slice(0, 10);
            }
            
            // 履歴を保存
            saveHistory();
            
            // 履歴リストを更新
            renderHistoryList();
        }
        
        // 履歴リストを表示
        function renderHistoryList() {
            const historyList = document.getElementById('historyList');

            // 履歴がない場合
            if (calculationHistory.length === 0) {
                historyList.innerHTML = '<div class="history-empty" role="status">計算履歴はありません</div>';
                return;
            }

            // 履歴リストを生成
            historyList.innerHTML = '';

            calculationHistory.forEach((entry, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.setAttribute('role', 'button');
                historyItem.setAttribute('tabindex', '0');
                historyItem.setAttribute('aria-label', `計算結果 ${calculationHistory.length - index} を読み込む`);

                // クリックイベントと、キーボードでのアクセシビリティ対応
                historyItem.onclick = function() {
                    loadHistoryEntry(index);
                };
                historyItem.onkeydown = function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault(); // スペースキーのスクロールを防止
                        loadHistoryEntry(index);
                    }
                };

                // 肥料名を取得
                let fertilizerNames = entry.fertilizers.map(f => f.name).join(', ');
                if (fertilizerNames.length > 50) {
                    fertilizerNames = fertilizerNames.substring(0, 50) + '...';
                }

                // NPK比率を抽出
                const npkRatio = `${entry.result.finalN.toFixed(1)}-${entry.result.finalP.toFixed(1)}-${entry.result.finalK.toFixed(1)}`;

                historyItem.innerHTML = `
                    <h4>計算結果 #${calculationHistory.length - index}</h4>
                    <div class="npk-ratio">NPK比率: ${npkRatio}</div>
                    <div>使用肥料: ${fertilizerNames}</div>
                    <div class="timestamp">${entry.timestamp}</div>
                `;

                historyList.appendChild(historyItem);
            });
        }
        
        // 履歴エントリーを読み込む
        function loadHistoryEntry(index) {
            const entry = calculationHistory[index];
            
            // 肥料リストを復元
            fertilizers = JSON.parse(JSON.stringify(entry.fertilizers));
            
            // 肥料リストを更新
            updateFertilizerList();
            
            // 計算結果を表示
            displaySavedResult(entry.result);
            
            // 結果タブに切り替え
            switchTab('resultsTab');
        }
        
        // 保存された結果を表示
        function displaySavedResult(result) {
            const resultsDiv = document.getElementById('calculationResults');
            resultsDiv.innerHTML = `
                <h3>主要成分</h3>
                <table>
                    <tr>
                        <th>総使用量</th>
                        <th>窒素 (N)</th>
                        <th>リン酸 (P)</th>
                        <th>カリウム (K)</th>
                    </tr>
                    <tr>
                        <td>${result.totalAmount >= 1000 ? (result.totalAmount / 1000).toFixed(2) + ' kg' : result.totalAmount.toFixed(1) + ' g'}</td>
                        <td>${result.totalN.toFixed(2)} g (${result.finalN.toFixed(2)}%)</td>
                        <td>${result.totalP.toFixed(2)} g (${result.finalP.toFixed(2)}%)</td>
                        <td>${result.totalK.toFixed(2)} g (${result.finalK.toFixed(2)}%)</td>
                    </tr>
                </table>
                
                <h3>二次栄養素</h3>
                <table>
                    <tr>
                        <th>カルシウム (Ca)</th>
                        <th>マグネシウム (Mg)</th>
                        <th>硫黄 (S)</th>
                    </tr>
                    <tr>
                        <td>${result.totalCa.toFixed(2)} g (${result.finalCa.toFixed(2)}%)</td>
                        <td>${result.totalMg.toFixed(2)} g (${result.finalMg.toFixed(2)}%)</td>
                        <td>${result.totalS.toFixed(2)} g (${result.finalS.toFixed(2)}%)</td>
                    </tr>
                </table>
                
                <h3>微量栄養素</h3>
                <table>
                    <tr>
                        <th>鉄 (Fe)</th>
                        <th>マンガン (Mn)</th>
                        <th>亜鉛 (Zn)</th>
                        <th>ホウ素 (B)</th>
                    </tr>
                    <tr>
                        <td>${result.totalFe.toFixed(2)} g (${result.finalFe.toFixed(3)}%)</td>
                        <td>${result.totalMn.toFixed(2)} g (${result.finalMn.toFixed(3)}%)</td>
                        <td>${result.totalZn.toFixed(2)} g (${result.finalZn.toFixed(3)}%)</td>
                        <td>${result.totalB.toFixed(2)} g (${result.finalB.toFixed(3)}%)</td>
                    </tr>
                </table>
                
                <h3>最終NPK比率: ${result.finalN.toFixed(1)}-${result.finalP.toFixed(1)}-${result.finalK.toFixed(1)}</h3>
                <p>※ 注意: これは肥料の混合総重量に対する各成分の割合です。</p>
                <p><em>※ この結果は履歴から読み込まれました</em></p>
            `;
        }
        
        // プリセットボタンを描画する
        function renderPresets() {
            const container = document.getElementById('userPresetContainer');
            container.innerHTML = '';

            // アクセシビリティのためにプリセットグループの説明を追加
            if (container.getAttribute('aria-describedby') !== 'preset-description') {
                const description = document.createElement('div');
                description.id = 'preset-description';
                description.className = 'visually-hidden';
                description.textContent = 'これらのボタンをクリックすると、対応する肥料の情報が入力フォームに自動入力されます。';
                container.setAttribute('aria-describedby', 'preset-description');

                // 説明をページに追加（コンテナの前）
                container.parentNode.insertBefore(description, container);
            }

            // 表示するデフォルトプリセット
            defaultPresets.filter(preset => preset.isVisible).forEach(preset => {
                const displayName = getPresetDisplayName(preset);
                const btn = document.createElement('button');
                btn.className = 'preset-btn';
                btn.textContent = displayName;
                btn.setAttribute('aria-label', `${preset.name}を選択: 窒素${preset.nitrogen}%, リン酸${preset.phosphorus}%, カリウム${preset.potassium}%`);
                btn.onclick = function() {
                    addPreset(
                        preset.name,
                        preset.nitrogen,
                        preset.phosphorus,
                        preset.potassium,
                        preset.calcium,
                        preset.magnesium,
                        preset.sulfur,
                        preset.iron,
                        preset.manganese,
                        preset.zinc,
                        preset.boron
                    );
                };
                container.appendChild(btn);
            });

            // ユーザープリセット
            userPresets.forEach(preset => {
                const displayName = getPresetDisplayName(preset);
                const btn = document.createElement('button');
                btn.className = 'preset-btn';
                btn.textContent = displayName;
                btn.setAttribute('aria-label', `${preset.name}を選択: 窒素${preset.nitrogen}%, リン酸${preset.phosphorus}%, カリウム${preset.potassium}%`);
                btn.setAttribute('data-preset-type', 'user');
                btn.onclick = function() {
                    addPreset(
                        preset.name,
                        preset.nitrogen,
                        preset.phosphorus,
                        preset.potassium,
                        preset.calcium,
                        preset.magnesium,
                        preset.sulfur,
                        preset.iron,
                        preset.manganese,
                        preset.zinc,
                        preset.boron
                    );
                };
                container.appendChild(btn);
            });

            // プリセットが一つもない場合
            if (container.children.length === 0) {
                const noPresets = document.createElement('p');
                noPresets.textContent = '表示するプリセットがありません。プリセット管理から設定できます。';
                noPresets.setAttribute('role', 'status');
                container.appendChild(noPresets);
            }
        }
        
        // プリセットの表示名を生成
        function getPresetDisplayName(preset) {
            let name = preset.name;
            
            // NPK値を追加
            const npk = `(${preset.nitrogen}-${preset.phosphorus}-${preset.potassium}`;
            
            // NPK以外の主要な成分を追加
            const extras = [];
            if (preset.calcium > 0) extras.push(`Ca${preset.calcium}`);
            if (preset.magnesium > 0) extras.push(`Mg${preset.magnesium}`);
            if (preset.sulfur > 0) extras.push(`S${preset.sulfur}`);
            
            // 追加成分がある場合は追加
            const extrasText = extras.length > 0 ? '+' + extras.join(',') : '';
            
            return `${name} ${npk}${extrasText})`;
        }
        
        // プリセット管理モーダルを開く
        function openPresetsModal() {
            const modal = document.getElementById('presetsModal');
            modal.style.display = 'block';
            modal.setAttribute('aria-hidden', 'false');

            // モーダルを開いたときに最初の要素にフォーカスを移動
            const closeButton = modal.querySelector('.close-modal');

            // アニメーションのために少し遅延させる
            setTimeout(() => {
                modal.classList.add('show');
                // フォーカストラップのためにフォーカスを移動
                if (closeButton) {
                    closeButton.focus();
                }
            }, 10);

            // モーダル表示前に内容を更新
            renderPresetLists();

            // ESCキーでモーダルを閉じられるようにする
            document.addEventListener('keydown', handleEscapeKey);
        }

        // プリセット管理モーダルを閉じる
        function closePresetsModal() {
            const modal = document.getElementById('presetsModal');
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');

            // ESCキーイベントリスナーを削除
            document.removeEventListener('keydown', handleEscapeKey);

            // アニメーションの後にモーダルを非表示にする
            setTimeout(() => {
                modal.style.display = 'none';

                // フォーカスを元の「プリセット管理」ボタンに戻す
                const presetManageBtn = document.querySelector('.manage-presets-btn');
                if (presetManageBtn) {
                    presetManageBtn.focus();
                }
            }, 300);
        }

        // ESCキーを押したときにモーダルを閉じる
        function handleEscapeKey(e) {
            if (e.key === 'Escape') {
                closePresetsModal();
            }
        }
        
        // プリセットリストを表示する
        function renderPresetLists() {
            // デフォルトプリセットリスト
            const defaultList = document.getElementById('defaultPresetList');
            defaultList.innerHTML = '';

            defaultPresets.forEach((preset, index) => {
                const item = document.createElement('div');
                item.className = 'preset-item default-preset-item';

                const label = document.createElement('label');
                label.className = 'checkbox-label';
                label.setAttribute('for', `default-preset-${index}`);

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `default-preset-${index}`;
                checkbox.checked = preset.isVisible;
                checkbox.setAttribute('aria-label', `${preset.name}を表示する`);
                checkbox.onchange = function() {
                    preset.isVisible = checkbox.checked;
                    saveSettings();
                    renderPresets();

                    // スクリーンリーダー用の状態通知
                    const status = document.createElement('div');
                    status.setAttribute('role', 'status');
                    status.className = 'visually-hidden';
                    status.textContent = `${preset.name}を${checkbox.checked ? '表示' : '非表示'}に設定しました`;
                    document.body.appendChild(status);

                    // 一定時間後に通知を削除
                    setTimeout(() => {
                        document.body.removeChild(status);
                    }, 1000);
                };

                const displayName = document.createElement('span');
                displayName.textContent = getPresetDisplayName(preset);

                label.appendChild(checkbox);
                label.appendChild(displayName);

                // 説明を追加
                const description = document.createElement('small');
                description.textContent = '（表示/非表示のみ変更可能）';
                description.style.marginLeft = '10px';
                description.style.color = '#777';
                description.setAttribute('aria-hidden', 'true'); // スクリーンリーダーでは冗長なので非表示

                item.appendChild(label);
                label.appendChild(description);
                defaultList.appendChild(item);
            });

            // ユーザープリセットリスト
            const userList = document.getElementById('userPresetList');
            userList.innerHTML = '';

            if (userPresets.length === 0) {
                const emptyMessage = document.createElement('p');
                emptyMessage.textContent = 'カスタムプリセットはありません。下のフォームから追加できます。';
                emptyMessage.setAttribute('role', 'status');
                userList.appendChild(emptyMessage);
            } else {
                userPresets.forEach((preset, index) => {
                    const item = document.createElement('div');
                    item.className = 'preset-item';

                    const name = document.createElement('span');
                    name.textContent = getPresetDisplayName(preset);

                    const actions = document.createElement('div');
                    actions.className = 'preset-item-actions';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = '削除';
                    deleteBtn.setAttribute('aria-label', `${preset.name}を削除する`);
                    deleteBtn.onclick = function() {
                        if (confirm(`"${preset.name}"を削除しますか？`)) {
                            userPresets.splice(index, 1);
                            saveSettings();
                            renderPresetLists();
                            renderPresets();

                            // スクリーンリーダー用の状態通知
                            const status = document.createElement('div');
                            status.setAttribute('role', 'status');
                            status.className = 'visually-hidden';
                            status.textContent = `${preset.name}が削除されました`;
                            document.body.appendChild(status);

                            // 一定時間後に通知を削除
                            setTimeout(() => {
                                document.body.removeChild(status);
                            }, 1000);
                        }
                    };

                    actions.appendChild(deleteBtn);

                    item.appendChild(name);
                    item.appendChild(actions);
                    userList.appendChild(item);
                });
            }
        }
        
        // 新しいプリセットを追加
        function addNewPreset() {
            const name = document.getElementById('newPresetName').value;
            const n = parseFloat(document.getElementById('newPresetN').value) || 0;
            const p = parseFloat(document.getElementById('newPresetP').value) || 0;
            const k = parseFloat(document.getElementById('newPresetK').value) || 0;
            const ca = parseFloat(document.getElementById('newPresetCa').value) || 0;
            const mg = parseFloat(document.getElementById('newPresetMg').value) || 0;
            const s = parseFloat(document.getElementById('newPresetS').value) || 0;
            const fe = parseFloat(document.getElementById('newPresetFe').value) || 0;
            const mn = parseFloat(document.getElementById('newPresetMn').value) || 0;
            const zn = parseFloat(document.getElementById('newPresetZn').value) || 0;
            const b = parseFloat(document.getElementById('newPresetB').value) || 0;
            
            if (!name) {
                alert('肥料名を入力してください');
                return;
            }
            
            // 新しいプリセットを作成
            const newPreset = {
                id: 'u' + Date.now(),  // ユニークIDを生成
                name,
                nitrogen: n,
                phosphorus: p,
                potassium: k,
                calcium: ca,
                magnesium: mg,
                sulfur: s,
                iron: fe,
                manganese: mn,
                zinc: zn,
                boron: b
            };
            
            // ユーザープリセットに追加
            userPresets.push(newPreset);
            
            // 設定を保存
            saveSettings();
            
            // 入力フィールドをクリア
            clearNewPresetFields();
            
            // リストを更新
            renderPresetLists();
            renderPresets();
            
            alert('新しいプリセットが追加されました');
        }
        
        // 新しいプリセット入力フィールドをクリア
        function clearNewPresetFields() {
            document.getElementById('newPresetName').value = '';
            document.getElementById('newPresetN').value = '';
            document.getElementById('newPresetP').value = '';
            document.getElementById('newPresetK').value = '';
            document.getElementById('newPresetCa').value = '';
            document.getElementById('newPresetMg').value = '';
            document.getElementById('newPresetS').value = '';
            document.getElementById('newPresetFe').value = '';
            document.getElementById('newPresetMn').value = '';
            document.getElementById('newPresetZn').value = '';
            document.getElementById('newPresetB').value = '';
        }
        
        // 詳細フィールドの表示切り替え
        function toggleAdvancedFields() {
            const advancedFields = document.getElementById('advancedFields');
            const toggleButton = document.querySelector('.toggle-section');

            if (advancedFields.style.display === 'none' || advancedFields.style.display === '') {
                advancedFields.style.display = 'block';

                // アクセシビリティ属性を更新
                toggleButton.setAttribute('aria-expanded', 'true');
                toggleButton.textContent = '▲ 微量要素の入力（クリックで表示/非表示）';

                // フォーカスを最初の入力フィールドに移動
                const firstInput = advancedFields.querySelector('input');
                if (firstInput) {
                    firstInput.focus();
                }
            } else {
                advancedFields.style.display = 'none';

                // アクセシビリティ属性を更新
                toggleButton.setAttribute('aria-expanded', 'false');
                toggleButton.textContent = '▼ 微量要素の入力（クリックで表示/非表示）';
            }
        }
        
        // タブ切り替え
        function switchTab(tabId) {
            // すべてのタブコンテンツを非表示
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
                content.setAttribute('hidden', 'true');
                content.setAttribute('aria-hidden', 'true');
            });

            // すべてのタブを非アクティブ
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });

            // 選択したタブとコンテンツをアクティブに
            const activeContent = document.getElementById(tabId);
            activeContent.classList.add('active');
            activeContent.removeAttribute('hidden');
            activeContent.setAttribute('aria-hidden', 'false');

            const activeTabBtn = document.getElementById(tabId + '-btn');
            activeTabBtn.classList.add('active');
            activeTabBtn.setAttribute('aria-selected', 'true');
            activeTabBtn.focus(); // キーボードフォーカスを維持
        }
        
        // プリセット肥料を追加する関数
        function addPreset(name, n, p, k, ca, mg, s, fe, mn, zn, b) {
            document.getElementById('fertilizerName').value = name;
            document.getElementById('nitrogenContent').value = n;
            document.getElementById('phosphorusContent').value = p;
            document.getElementById('potassiumContent').value = k;
            document.getElementById('calciumContent').value = ca;
            document.getElementById('magnesiumContent').value = mg;
            document.getElementById('sulfurContent').value = s;
            document.getElementById('ironContent').value = fe;
            document.getElementById('manganeseContent').value = mn;
            document.getElementById('zincContent').value = zn;
            document.getElementById('boronContent').value = b;
            document.getElementById('otherContent').value = '';
            document.getElementById('amount').focus();
        }
        
        // 肥料を追加する関数
        function addFertilizer() {
            const nameInput = document.getElementById('fertilizerName');
            const name = nameInput.value;
            const nitrogen = parseFloat(document.getElementById('nitrogenContent').value) || 0;
            const phosphorus = parseFloat(document.getElementById('phosphorusContent').value) || 0;
            const potassium = parseFloat(document.getElementById('potassiumContent').value) || 0;
            const calcium = parseFloat(document.getElementById('calciumContent').value) || 0;
            const magnesium = parseFloat(document.getElementById('magnesiumContent').value) || 0;
            const sulfur = parseFloat(document.getElementById('sulfurContent').value) || 0;
            const iron = parseFloat(document.getElementById('ironContent').value) || 0;
            const manganese = parseFloat(document.getElementById('manganeseContent').value) || 0;
            const zinc = parseFloat(document.getElementById('zincContent').value) || 0;
            const boron = parseFloat(document.getElementById('boronContent').value) || 0;
            const other = document.getElementById('otherContent').value;
            const amountInput = document.getElementById('amount');
            let amount = parseFloat(amountInput.value) || 0;
            const unit = document.getElementById('amountUnit').value;

            // バリデーション失敗時のビジュアルフィードバック
            function showValidationError(element, message) {
                // 入力欄を赤くハイライト
                element.style.borderColor = '#e74c3c';
                element.style.backgroundColor = 'rgba(231, 76, 60, 0.05)';
                element.style.boxShadow = '0 0 5px rgba(231, 76, 60, 0.3)';

                // エラーメッセージを表示
                alert(message);

                // 入力欄にフォーカス
                element.focus();

                // 3秒後にハイライトを解除
                setTimeout(() => {
                    element.style.borderColor = '';
                    element.style.backgroundColor = '';
                    element.style.boxShadow = '';
                }, 3000);
            }

            if (!name) {
                showValidationError(nameInput, '肥料名を入力してください');
                return;
            }

            if (amount <= 0) {
                showValidationError(amountInput, '有効な使用量を入力してください');
                return;
            }

            // 成功時のビジュアルフィードバック
            const addFertilizerButton = document.querySelector('.add-fertilizer-btn');
            const originalBackground = addFertilizerButton.style.backgroundColor;

            // 成功エフェクト
            addFertilizerButton.style.backgroundColor = '#27ae60';
            addFertilizerButton.style.transform = 'scale(1.05)';

            // 元に戻す
            setTimeout(() => {
                addFertilizerButton.style.backgroundColor = originalBackground;
                addFertilizerButton.style.transform = '';
            }, 500);
            
            // kgの場合はグラムに変換
            const amountInGrams = unit === 'kg' ? amount * 1000 : amount;
            // 表示用の単位付き使用量
            const displayAmount = `${amount} ${unit}`;
            
            // 各成分の含有量をグラム単位で計算
            const nAmount = (nitrogen * amountInGrams) / 100;
            const pAmount = (phosphorus * amountInGrams) / 100;
            const kAmount = (potassium * amountInGrams) / 100;
            const caAmount = (calcium * amountInGrams) / 100;
            const mgAmount = (magnesium * amountInGrams) / 100;
            const sAmount = (sulfur * amountInGrams) / 100;
            const feAmount = (iron * amountInGrams) / 100;
            const mnAmount = (manganese * amountInGrams) / 100;
            const znAmount = (zinc * amountInGrams) / 100;
            const bAmount = (boron * amountInGrams) / 100;
            
            // 肥料オブジェクトを作成
            const fertilizer = {
                name,
                nitrogen,
                phosphorus,
                potassium,
                calcium,
                magnesium,
                sulfur,
                iron,
                manganese,
                zinc,
                boron,
                other,
                amount: amountInGrams,
                displayAmount,
                nAmount,
                pAmount,
                kAmount,
                caAmount,
                mgAmount,
                sAmount,
                feAmount,
                mnAmount,
                znAmount,
                bAmount
            };
            
            // 肥料を配列に追加
            fertilizers.push(fertilizer);
            
            // 肥料リストを更新
            updateFertilizerList();
            
            // 入力フィールドをクリア
            clearInputFields();
            
            // 肥料リストタブを表示
            switchTab('fertilizerTab');
        }
        
        // 肥料リストを更新する関数
        function updateFertilizerList() {
            const fertilizerList = document.getElementById('fertilizerList');
            fertilizerList.innerHTML = '';
            
            fertilizers.forEach((fert, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${fert.name}</td>
                    <td>${fert.nitrogen.toFixed(1)}</td>
                    <td>${fert.phosphorus.toFixed(1)}</td>
                    <td>${fert.potassium.toFixed(1)}</td>
                    <td>${fert.calcium.toFixed(1)}</td>
                    <td>${fert.magnesium.toFixed(1)}</td>
                    <td>${fert.sulfur.toFixed(1)}</td>
                    <td>${fert.displayAmount}</td>
                    <td><button class="delete-btn" onclick="deleteFertilizer(${index})">削除</button></td>
                `;
                
                fertilizerList.appendChild(row);
            });
        }
        
        // 肥料を削除する関数
        function deleteFertilizer(index) {
            fertilizers.splice(index, 1);
            updateFertilizerList();
        }
        
        // 入力フィールドをクリアする関数
        function clearInputFields() {
            document.getElementById('fertilizerName').value = '';
            document.getElementById('nitrogenContent').value = '';
            document.getElementById('phosphorusContent').value = '';
            document.getElementById('potassiumContent').value = '';
            document.getElementById('calciumContent').value = '';
            document.getElementById('magnesiumContent').value = '';
            document.getElementById('sulfurContent').value = '';
            document.getElementById('ironContent').value = '';
            document.getElementById('manganeseContent').value = '';
            document.getElementById('zincContent').value = '';
            document.getElementById('boronContent').value = '';
            document.getElementById('otherContent').value = '';
            document.getElementById('amount').value = '';
        }
        
        // 結果を計算する関数
        function calculateResults() {
            if (fertilizers.length === 0) {
                // エラーメッセージに視覚効果を追加
                const errorMsg = document.createElement('div');
                errorMsg.innerHTML = `
                    <div style="
                        padding: 15px;
                        background-color: #ffecec;
                        color: #e74c3c;
                        border-radius: 5px;
                        text-align: center;
                        box-shadow: 0 2px 10px rgba(231, 76, 60, 0.2);
                        animation: shake 0.5s ease-in-out;
                    ">
                        <span style="font-size: 24px; margin-right: 10px;">⚠️</span>
                        少なくとも1つの肥料を追加してください
                    </div>
                `;

                // CSS アニメーションの追加
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes shake {
                        0%, 100% { transform: translateX(0); }
                        20%, 60% { transform: translateX(-10px); }
                        40%, 80% { transform: translateX(10px); }
                    }
                `;
                document.head.appendChild(style);

                // エラー表示
                const resultsDiv = document.getElementById('calculationResults');
                resultsDiv.innerHTML = '';
                resultsDiv.appendChild(errorMsg);

                // 結果タブに切り替え
                switchTab('resultsTab');

                // 5秒後にメッセージを消す
                setTimeout(() => {
                    resultsDiv.innerHTML = '<p>まだ肥料が追加されていません</p>';
                }, 5000);

                return;
            }

            // 計算開始時のローディングエフェクト
            const resultsDiv = document.getElementById('calculationResults');
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="
                        width: 50px;
                        height: 50px;
                        border: 5px solid #f3f3f3;
                        border-top: 5px solid #2c7744;
                        border-radius: 50%;
                        margin: 0 auto;
                        animation: spin 1s linear infinite;
                    "></div>
                    <p style="margin-top: 15px;">計算中...</p>
                </div>
            `;

            // CSSアニメーションの追加
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);

            // 計算を少し遅延させて視覚効果を見せる
            setTimeout(() => {
                // 総使用量と各要素の総量を計算
                const totalAmount = fertilizers.reduce((sum, fert) => sum + fert.amount, 0);
                const totalN = fertilizers.reduce((sum, fert) => sum + fert.nAmount, 0);
                const totalP = fertilizers.reduce((sum, fert) => sum + fert.pAmount, 0);
                const totalK = fertilizers.reduce((sum, fert) => sum + fert.kAmount, 0);
                const totalCa = fertilizers.reduce((sum, fert) => sum + fert.caAmount, 0);
                const totalMg = fertilizers.reduce((sum, fert) => sum + fert.mgAmount, 0);
                const totalS = fertilizers.reduce((sum, fert) => sum + fert.sAmount, 0);
                const totalFe = fertilizers.reduce((sum, fert) => sum + fert.feAmount, 0);
                const totalMn = fertilizers.reduce((sum, fert) => sum + fert.mnAmount, 0);
                const totalZn = fertilizers.reduce((sum, fert) => sum + fert.znAmount, 0);
                const totalB = fertilizers.reduce((sum, fert) => sum + fert.bAmount, 0);
            
                // 最終的な含有率を計算
                const finalN = (totalN / totalAmount) * 100;
                const finalP = (totalP / totalAmount) * 100;
                const finalK = (totalK / totalAmount) * 100;
                const finalCa = (totalCa / totalAmount) * 100;
                const finalMg = (totalMg / totalAmount) * 100;
                const finalS = (totalS / totalAmount) * 100;
                const finalFe = (totalFe / totalAmount) * 100;
                const finalMn = (totalMn / totalAmount) * 100;
                const finalZn = (totalZn / totalAmount) * 100;
                const finalB = (totalB / totalAmount) * 100;

                // 結果オブジェクトを作成
                const result = {
                    totalAmount,
                    totalN,
                    totalP,
                    totalK,
                    totalCa,
                    totalMg,
                    totalS,
                    totalFe,
                    totalMn,
                    totalZn,
                    totalB,
                    finalN,
                    finalP,
                    finalK,
                    finalCa,
                    finalMg,
                    finalS,
                    finalFe,
                    finalMn,
                    finalZn,
                    finalB
                };

                // 履歴に追加
                addToHistory(result);

                // 結果のHTML作成（まだ表示せず）
                const resultHTML = `
                    <div class="result-content" style="opacity: 0; transform: translateY(20px); transition: all 0.5s ease-out;">
                        <h3>主要成分</h3>
                        <table>
                            <tr>
                                <th>総使用量</th>
                                <th>窒素 (N)</th>
                                <th>リン酸 (P)</th>
                                <th>カリウム (K)</th>
                            </tr>
                            <tr>
                                <td>${totalAmount >= 1000 ? (totalAmount / 1000).toFixed(2) + ' kg' : totalAmount.toFixed(1) + ' g'}</td>
                                <td>${totalN.toFixed(2)} g (${finalN.toFixed(2)}%)</td>
                                <td>${totalP.toFixed(2)} g (${finalP.toFixed(2)}%)</td>
                                <td>${totalK.toFixed(2)} g (${finalK.toFixed(2)}%)</td>
                            </tr>
                        </table>

                        <h3>二次栄養素</h3>
                        <table>
                            <tr>
                                <th>カルシウム (Ca)</th>
                                <th>マグネシウム (Mg)</th>
                                <th>硫黄 (S)</th>
                            </tr>
                            <tr>
                                <td>${totalCa.toFixed(2)} g (${finalCa.toFixed(2)}%)</td>
                                <td>${totalMg.toFixed(2)} g (${finalMg.toFixed(2)}%)</td>
                                <td>${totalS.toFixed(2)} g (${finalS.toFixed(2)}%)</td>
                            </tr>
                        </table>

                        <h3>微量栄養素</h3>
                        <table>
                            <tr>
                                <th>鉄 (Fe)</th>
                                <th>マンガン (Mn)</th>
                                <th>亜鉛 (Zn)</th>
                                <th>ホウ素 (B)</th>
                            </tr>
                            <tr>
                                <td>${totalFe.toFixed(2)} g (${finalFe.toFixed(3)}%)</td>
                                <td>${totalMn.toFixed(2)} g (${finalMn.toFixed(3)}%)</td>
                                <td>${totalZn.toFixed(2)} g (${finalZn.toFixed(3)}%)</td>
                                <td>${totalB.toFixed(2)} g (${finalB.toFixed(3)}%)</td>
                            </tr>
                        </table>

                        <div class="npk-result" style="
                            margin-top: 20px;
                            background: linear-gradient(135deg, #e9f7ef, #d5f5e3);
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
                            transform: scale(0.95);
                            transition: all 0.3s ease;
                        ">
                            <h3 style="margin-top: 0;">最終NPK比率: <span style="color: #2c7744;">${finalN.toFixed(1)}-${finalP.toFixed(1)}-${finalK.toFixed(1)}</span></h3>
                        </div>

                        <p style="margin-top: 20px; font-style: italic; color: #777;">※ 注意: これは肥料の混合総重量に対する各成分の割合です。</p>
                    </div>
                `;

                // 結果を表示してアニメーションを開始
                resultsDiv.innerHTML = resultHTML;

                // 結果タブに切り替え
                switchTab('resultsTab');

                // 要素のアニメーション（遅延させて表示）
                setTimeout(() => {
                    const resultContent = document.querySelector('.result-content');
                    if (resultContent) {
                        resultContent.style.opacity = 1;
                        resultContent.style.transform = 'translateY(0)';

                        // NPK比率のスケールアニメーション
                        setTimeout(() => {
                            const npkResult = document.querySelector('.npk-result');
                            if (npkResult) {
                                npkResult.style.transform = 'scale(1.05)';
                                npkResult.style.boxShadow = '0 5px 15px rgba(0,0,0,0.15)';
                            }
                        }, 500);
                    }
                }, 100);
            }, 800); // ローディングを0.8秒表示
        }
        
        // 計算機をリセットする関数
        function resetCalculator() {
            if (confirm('すべてのデータをリセットしますか？')) {
                fertilizers = [];
                updateFertilizerList();
                clearInputFields();
                document.getElementById('calculationResults').innerHTML = '<p>まだ肥料が追加されていません</p>';
            }
        }
        
        // モーダル外をクリックしたらモーダルを閉じる
        window.onclick = function(event) {
            const modal = document.getElementById('presetsModal');
            if (event.target === modal) {
                closePresetsModal();
            }
        };

        // アプリケーション初期化: UI効果とアクセシビリティ
        document.addEventListener('DOMContentLoaded', function() {
            // モバイルデバイス対応の初期化
            initMobileSupport();
            // UI: タブコンテンツが切り替わる際のアニメーションをリセット
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabContents = document.querySelectorAll('.tab-content');
                    tabContents.forEach(content => {
                        content.style.animation = 'none';
                        content.offsetHeight; // リフロー（再描画）をトリガー
                        content.style.animation = null;
                    });
                });

                // キーボードアクセシビリティ: タブのキーボード操作
                tab.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                        e.preventDefault();
                        const allTabs = Array.from(document.querySelectorAll('.tab'));
                        const currentIndex = allTabs.indexOf(this);
                        let nextIndex;

                        if (e.key === 'ArrowLeft') {
                            nextIndex = currentIndex > 0 ? currentIndex - 1 : allTabs.length - 1;
                        } else {
                            nextIndex = currentIndex < allTabs.length - 1 ? currentIndex + 1 : 0;
                        }

                        allTabs[nextIndex].focus();
                    }
                });
            });

            // UI: ボタンのリップルエフェクト
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function(e) {
                    // リップルエフェクトの要素を作成
                    const ripple = document.createElement('span');
                    this.appendChild(ripple);

                    // クリック位置を取得
                    const x = e.clientX - this.getBoundingClientRect().left;
                    const y = e.clientY - this.getBoundingClientRect().top;

                    // リップルの位置を設定
                    ripple.style.cssText = `
                        position: absolute;
                        background-color: rgba(255, 255, 255, 0.5);
                        border-radius: 50%;
                        width: 5px;
                        height: 5px;
                        top: ${y}px;
                        left: ${x}px;
                        transform: scale(0);
                        transition: transform 0.5s, opacity 0.5s;
                        pointer-events: none;
                    `;

                    // リップルアニメーション
                    setTimeout(() => {
                        ripple.style.transform = 'scale(50)';
                        ripple.style.opacity = '0';

                        // アニメーション後に要素を削除
                        setTimeout(() => {
                            ripple.remove();
                        }, 500);
                    }, 10);
                });

                // 削除ボタンのアクセシビリティ強化
                if (button.classList.contains('delete-btn') && !button.hasAttribute('aria-label')) {
                    button.setAttribute('aria-label', '削除');
                }
            });

            // アクセシビリティ: 初期タブの設定
            const activeTabs = document.querySelectorAll('.tab.active');
            activeTabs.forEach(tab => {
                tab.setAttribute('aria-selected', 'true');
            });

            // アクセシビリティ: 初期タブコンテンツの設定
            const initialActiveContents = document.querySelectorAll('.tab-content.active');
            initialActiveContents.forEach(content => {
                content.removeAttribute('hidden');
                content.setAttribute('aria-hidden', 'false');
            });

            const inactiveContents = document.querySelectorAll('.tab-content:not(.active)');
            inactiveContents.forEach(content => {
                content.setAttribute('hidden', 'true');
                content.setAttribute('aria-hidden', 'true');
            });

            // アクセシビリティ: 通知システムの初期化
            if (!document.getElementById('accessibility-announcer')) {
                const announcer = document.createElement('div');
                announcer.id = 'accessibility-announcer';
                announcer.className = 'visually-hidden';
                announcer.setAttribute('role', 'status');
                announcer.setAttribute('aria-live', 'polite');
                document.body.appendChild(announcer);
            }

            // アクセシビリティ: 高コントラストモード検出
            function checkHighContrastMode() {
                const highContrastStyle = document.createElement('div');
                highContrastStyle.style.color = 'canvastext';
                highContrastStyle.style.backgroundColor = 'canvas';
                document.body.appendChild(highContrastStyle);

                const computedStyle = getComputedStyle(highContrastStyle);
                const isHighContrast =
                    computedStyle.backgroundColor === 'rgb(255, 255, 255)' &&
                    computedStyle.color === 'rgb(0, 0, 0)';

                document.body.removeChild(highContrastStyle);

                if (isHighContrast) {
                    document.body.classList.add('high-contrast-mode');
                }
            }

            // 高コントラストモード検出を実行
            checkHighContrastMode();

            // ダークモード設定の初期化
            initThemeToggle();
        });

        // ダークモード切り替え機能
        function initThemeToggle() {
            const themeToggleBtn = document.getElementById('themeToggle');

            // ローカルストレージからユーザー設定を読み込む
            const userPrefersDark = localStorage.getItem('darkMode') === 'true';

            // OSの設定をチェック
            const systemPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

            // ダークモードを適用すべきか決定
            const shouldApplyDark = userPrefersDark !== null ? userPrefersDark : systemPrefersDark;

            // 初期状態を設定
            if (shouldApplyDark) {
                document.body.classList.add('dark-mode');
                themeToggleBtn.innerText = '🌞'; // 太陽アイコン（明るくするオプション）
            } else {
                themeToggleBtn.innerText = '🌙'; // 月アイコン（暗くするオプション）
            }

            // クリックイベントを追加
            themeToggleBtn.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');

                // ダークモードがアクティブかどうかの新しい状態
                const isDarkMode = document.body.classList.contains('dark-mode');

                // ローカルストレージに設定を保存
                localStorage.setItem('darkMode', isDarkMode);

                // アイコンを更新
                themeToggleBtn.innerText = isDarkMode ? '🌞' : '🌙';

                // スクリーンリーダー用の通知
                const modeAnnouncer = document.createElement('div');
                modeAnnouncer.className = 'visually-hidden';
                modeAnnouncer.setAttribute('role', 'status');
                modeAnnouncer.setAttribute('aria-live', 'polite');
                modeAnnouncer.textContent = isDarkMode ? 'ダークモードに切り替えました' : 'ライトモードに切り替えました';
                document.body.appendChild(modeAnnouncer);

                // 通知を一定時間後に削除
                setTimeout(() => {
                    document.body.removeChild(modeAnnouncer);
                }, 1000);
            });

            // OS設定の変更を監視
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    // ユーザーが明示的に設定していない場合のみOSの設定に従う
                    if (localStorage.getItem('darkMode') === null) {
                        const shouldBeDark = event.matches;
                        document.body.classList.toggle('dark-mode', shouldBeDark);
                        themeToggleBtn.innerText = shouldBeDark ? '🌞' : '🌙';
                    }
                });
            }
        }

        // モバイルデバイス向けの最適化
        function initMobileSupport() {
            // iOSでのダブルタップズームを防止
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            // FastClickの実装（タップの遅延を解消）
            const attachFastClick = function() {
                const touchElements = document.querySelectorAll('button, .preset-btn, .tab');
                touchElements.forEach(el => {
                    let touchStartTime = 0;
                    let touchStartX = 0;
                    let touchStartY = 0;

                    el.addEventListener('touchstart', function(e) {
                        touchStartTime = Date.now();
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                    }, { passive: true });

                    el.addEventListener('touchend', function(e) {
                        const touchTime = Date.now() - touchStartTime;
                        const touchEndX = e.changedTouches[0].clientX;
                        const touchEndY = e.changedTouches[0].clientY;
                        const touchDistance = Math.sqrt(
                            Math.pow(touchEndX - touchStartX, 2) +
                            Math.pow(touchEndY - touchStartY, 2)
                        );

                        // 短時間タップかつ移動距離が少ない場合にのみクリックと判定
                        if (touchTime < 300 && touchDistance < 10) {
                            e.preventDefault();
                            const clickEvent = new MouseEvent('click', {
                                view: window,
                                bubbles: true,
                                cancelable: true
                            });
                            el.dispatchEvent(clickEvent);
                        }
                    });
                });
            };

            // モバイルデバイスの検出
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (isMobile) {
                attachFastClick();

                // スワイプヒントのアニメーション
                const swipeHints = document.querySelectorAll('.mobile-swipe-hint');
                swipeHints.forEach(hint => {
                    hint.style.display = 'block';
                });

                // テーブルのスクロールを分かりやすく
                const tableContainers = document.querySelectorAll('.table-responsive');
                tableContainers.forEach(container => {
                    container.addEventListener('scroll', function() {
                        // スクロールしたらヒントを隠す
                        const hint = container.parentNode.querySelector('.mobile-swipe-hint');
                        if (hint) {
                            setTimeout(() => {
                                hint.style.opacity = '0';
                                setTimeout(() => {
                                    hint.style.display = 'none';
                                }, 500);
                            }, 1000);
                        }
                    });
                });

                // 入力フィールドにフォーカスしたとき、ビューポートを調整
                const inputFields = document.querySelectorAll('input, select');
                inputFields.forEach(field => {
                    field.addEventListener('focus', function() {
                        // モバイルでキーボードが表示されたときにスクロール位置を調整
                        setTimeout(() => {
                            field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    });
                });
            }
        }
    </script>
</body>
</html>