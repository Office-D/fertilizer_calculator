<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="è‚¥æ–™ã®å«æœ‰ç‡ã¨ä½¿ç”¨é‡ã‹ã‚‰å„æ „é¤Šç´ ã®é‡ã‚’è¨ˆç®—ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚">
    <title>è‚¥æ–™è¨ˆç®—æ©Ÿ</title>
    <!-- ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šã®ãŸã‚ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« -->
    <style id="accessibility-focus">
        *:focus {
            outline: 2px solid #3498db !important;
            outline-offset: 2px !important;
        }

        /* ã‚¹ã‚­ãƒƒãƒ—ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #2c7744;
            color: white;
            padding: 8px;
            z-index: 100;
            transition: top 0.3s;
        }
        .skip-link:focus {
            top: 0;
        }

        /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ç”¨ã«è¦–è¦šçš„ã«éš ã™ï¼ˆã ãŒèª­ã¿ä¸Šã’å¯èƒ½ï¼‰ */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
        @media (forced-colors: active) {
            button, .tab, .preset-btn {
                border: 1px solid currentColor;
            }

            .tab.active {
                border: 2px solid currentColor;
            }
        }
    </style>
    <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œã®ãŸã‚ã®CSSå¤‰æ•° -->
    <style id="theme-variables">
        :root {
            --color-bg-primary: #f8f9fa;
            --color-bg-secondary: #ffffff;
            --color-bg-tertiary: #e9f7ef;
            --color-bg-accent: #eaf2fa;
            --color-text-primary: #333;
            --color-text-secondary: #555;
            --color-text-muted: #777;
            --color-text-heading: #2c7744;
            --color-border: #ddd;
            --color-primary: #2c7744;
            --color-primary-hover: #1e5e30;
            --color-shadow: rgba(0, 0, 0, 0.1);
            --color-shadow-strong: rgba(0, 0, 0, 0.2);
            --color-preset: #3498db;
            --color-preset-hover: #2980b9;
            --color-error: #e74c3c;
            --color-error-bg: #ffecec;
            --color-warning: #f39c12;
            --color-warning-hover: #e67e22;
            --color-success: #27ae60;
            --color-success-hover: #219955;
            --color-cancel: #95a5a6;
            --color-cancel-hover: #7f8c8d;
            --color-history: #9b59b6;
            --color-history-hover: #8e44ad;
            --color-table-header: #e6f0e9;
            --color-table-hover: #f5f9ff;
        }

        body.dark-mode {
            --color-bg-primary: #121212;
            --color-bg-secondary: #1e1e1e;
            --color-bg-tertiary: #1a3028;
            --color-bg-accent: #1e2a38;
            --color-text-primary: #e0e0e0;
            --color-text-secondary: #b0b0b0;
            --color-text-muted: #909090;
            --color-text-heading: #4caf50;
            --color-border: #333;
            --color-primary: #4caf50;
            --color-primary-hover: #388e3c;
            --color-shadow: rgba(0, 0, 0, 0.3);
            --color-shadow-strong: rgba(0, 0, 0, 0.4);
            --color-preset: #2196f3;
            --color-preset-hover: #1976d2;
            --color-error: #f44336;
            --color-error-bg: #2d1a1a;
            --color-warning: #ff9800;
            --color-warning-hover: #f57c00;
            --color-success: #2ecc71;
            --color-success-hover: #27ae60;
            --color-cancel: #607d8b;
            --color-cancel-hover: #455a64;
            --color-history: #9c27b0;
            --color-history-hover: #7b1fa2;
            --color-table-header: #1a372a;
            --color-table-hover: #1e2a38;
        }
    </style>

    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--color-text-primary);
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--color-bg-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        h1 {
            color: var(--color-text-heading);
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 1px 1px 3px var(--color-shadow);
        }
        .container {
            background-color: var(--color-bg-secondary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 3px 15px var(--color-shadow);
            transition: box-shadow 0.3s ease, background-color 0.3s ease;
        }
        .container:hover {
            box-shadow: 0 5px 20px var(--color-shadow-strong);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            transition: color 0.2s ease;
            color: var(--color-text-primary);
        }
        label:hover {
            color: var(--color-primary);
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            box-sizing: border-box;
            transition: all 0.2s ease-in-out;
            background-color: var(--color-bg-secondary);
            color: var(--color-text-primary);
        }
        input:hover, select:hover {
            border-color: var(--color-preset);
        }
        input:focus, select:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 5px var(--color-primary);
            outline: none;
        }
        button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px var(--color-shadow);
            position: relative;
            overflow: hidden;
        }
        button:hover {
            background-color: var(--color-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--color-shadow-strong);
        }
        button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px var(--color-shadow);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9em;
            box-shadow: 0 2px 10px var(--color-shadow);
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--color-bg-secondary);
        }
        th, td {
            border: 1px solid var(--color-border);
            padding: 8px;
            text-align: left;
            transition: background-color 0.2s ease;
        }
        tr:hover td {
            background-color: var(--color-table-hover);
        }
        th {
            background-color: var(--color-table-header);
            color: var(--color-text-heading);
            position: sticky;
            top: 0;
            box-shadow: 0 1px 2px var(--color-shadow);
        }
        .results {
            margin-top: 30px;
            padding: 15px;
            background-color: var(--color-bg-tertiary);
            border-radius: 8px;
            box-shadow: 0 3px 10px var(--color-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease;
        }
        .results:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--color-shadow-strong);
        }
        .results h2 {
            color: var(--color-text-heading);
            margin-top: 0;
            text-shadow: 1px 1px 2px var(--color-shadow);
        }
        .control-buttons {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
        }
        .control-buttons-left {
            display: flex;
            gap: 10px;
        }
        .control-buttons-right {
            display: flex;
            gap: 10px;
        }
        .delete-btn {
            background-color: var(--color-error);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px var(--color-shadow);
        }
        .delete-btn:hover {
            background-color: var(--color-error);
            filter: brightness(0.9);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px var(--color-shadow-strong);
        }
        .delete-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px var(--color-shadow);
        }
        .fertilizer-presets {
            margin-bottom: 20px;
        }
        .preset-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .preset-btn {
            background-color: var(--color-preset);
            font-size: 14px;
            transition: all 0.25s ease;
            transform-origin: center;
            box-shadow: 0 2px 4px var(--color-shadow);
        }
        .preset-btn:hover {
            background-color: var(--color-preset-hover);
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 4px 8px var(--color-shadow-strong);
        }
        .preset-btn:active {
            transform: translateY(1px) scale(0.98);
            box-shadow: 0 1px 2px var(--color-shadow);
        }

        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            box-shadow: 0 2px 5px var(--color-shadow);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: rotate(30deg);
            box-shadow: 0 2px 8px var(--color-shadow-strong);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .form-grid .form-group:nth-child(1),
        .form-grid .form-group:nth-child(5) {
            grid-column: 1 / -1;
        }
        .toggle-section {
            cursor: pointer;
            color: var(--color-preset);
            font-weight: bold;
            margin: 15px 0;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.2s ease;
            background-color: var(--color-bg-accent);
            display: inline-block;
        }
        .toggle-section:hover {
            background-color: var(--color-bg-accent);
            filter: brightness(0.95);
            box-shadow: 0 2px 5px var(--color-shadow);
            transform: translateY(-1px);
        }
        .toggle-section:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        #advancedFields {
            display: none;
            border-top: 1px dashed var(--color-border);
            padding-top: 15px;
            margin-top: 15px;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 5px var(--color-shadow);
        }
        .tab {
            padding: 12px 20px;
            background-color: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
            flex-grow: 1;
            text-align: center;
            font-weight: 500;
        }
        .tab:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-primary);
            opacity: 0.1;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: -1;
        }
        .tab:hover:before {
            transform: translateY(0);
        }
        .tab.active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
            box-shadow: 0 2px 5px var(--color-shadow-strong);
            transform: translateY(-2px);
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        .tab-content.active {
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal.show {
            opacity: 1;
        }
        .modal-content {
            background-color: var(--color-bg-secondary);
            color: var(--color-text-primary);
            margin: 50px auto;
            padding: 25px;
            width: 80%;
            max-width: 700px;
            border-radius: 8px;
            box-shadow: 0 10px 30px var(--color-shadow-strong);
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(-30px);
            opacity: 0;
            transition: all 0.4s ease;
        }
        .modal.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        .close-modal:hover {
            color: #555;
            background-color: #f5f5f5;
            transform: rotate(90deg);
        }
        .preset-settings {
            margin-top: 20px;
        }
        .preset-settings table {
            margin-bottom: 20px;
        }
        .preset-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .preset-actions button {
            margin-right: 5px;
        }
        .preset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            transition: all 0.2s ease;
            border-radius: 4px;
        }
        .preset-item:hover {
            background-color: #f9f9f9;
            transform: translateX(2px);
        }
        .preset-item:last-child {
            border-bottom: none;
        }
        .preset-item-actions {
            display: flex;
            gap: 5px;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .checkbox-label:hover {
            background-color: #f0f0f0;
        }
        .checkbox-label input {
            width: auto;
            margin-right: 8px;
            transform: scale(1.2);
            transition: all 0.2s ease;
        }
        .checkbox-label:hover input {
            transform: scale(1.3);
        }
        .manage-presets-btn {
            background-color: var(--color-warning);
            margin-left: auto;
            display: block;
            position: relative;
            overflow: hidden;
        }
        .manage-presets-btn:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        .manage-presets-btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        @keyframes ripple {
            0% { transform: scale(0, 0); opacity: 0.5; }
            20% { transform: scale(25, 25); opacity: 0.3; }
            100% { opacity: 0; transform: scale(40, 40); }
        }
        .manage-presets-btn:hover {
            background-color: var(--color-warning-hover);
        }
        .add-preset-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid var(--color-border);
            animation: fadeIn 0.5s ease;
        }
        .save-btn {
            background-color: var(--color-success);
            position: relative;
            overflow: hidden;
        }
        .save-btn:hover {
            background-color: var(--color-success-hover);
        }
        .save-btn:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255,255,255,0.2), rgba(255,255,255,0));
            transform: translateY(-100%);
        }
        .save-btn:hover:after {
            transform: translateY(0);
            transition: transform 0.3s ease;
        }
        .cancel-btn {
            background-color: var(--color-cancel);
        }
        .cancel-btn:hover {
            background-color: var(--color-cancel-hover);
        }
        .button-spacer {
            margin-top: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        .add-fertilizer-btn {
            background-color: var(--color-primary);
            font-size: 18px;
            padding: 12px 25px;
            margin: 0 auto;
            display: block;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 10px var(--color-shadow);
            transition: all 0.3s ease;
        }
        .add-fertilizer-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px var(--color-shadow-strong);
            background-color: var(--color-primary-hover);
        }
        .add-fertilizer-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 5px var(--color-shadow);
        }
        .default-preset-item {
            opacity: 0.85;
            transition: opacity 0.2s ease;
        }
        .default-preset-item:hover {
            opacity: 1;
        }
        .preset-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--color-border);
        }
        .history-btn {
            background-color: var(--color-history);
        }
        .history-btn:hover {
            background-color: var(--color-history-hover);
        }
        .history-item {
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 2px 5px var(--color-shadow);
            background-color: var(--color-bg-secondary);
        }
        .history-item:hover {
            background-color: var(--color-table-hover);
            transform: translateY(-3px) scale(1.01);
            box-shadow: 0 5px 15px var(--color-shadow-strong);
            border-color: var(--color-preset);
        }
        .history-item h4 {
            margin-top: 0;
            color: var(--color-text-heading);
            transition: color 0.2s ease;
        }
        .history-item:hover h4 {
            color: var(--color-preset);
        }
        .history-item .npk-ratio {
            font-weight: bold;
            color: var(--color-text-primary);
            transition: all 0.2s ease;
        }
        .history-item:hover .npk-ratio {
            color: var(--color-primary);
            transform: scale(1.05);
        }
        .history-item .timestamp {
            color: var(--color-text-muted);
            font-size: 0.9em;
            text-align: right;
            margin-top: 10px;
        }
        .history-empty {
            text-align: center;
            color: var(--color-text-muted);
            font-style: italic;
            padding: 30px;
            background-color: var(--color-bg-secondary);
            border-radius: 8px;
            animation: pulse 2s infinite ease-in-out;
        }
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* ã‚¹ãƒ¯ã‚¤ãƒ—ãƒ’ãƒ³ãƒˆ */
        .mobile-swipe-hint {
            display: none;
            text-align: center;
            color: var(--color-text-muted);
            font-style: italic;
            margin-top: 5px;
            animation: pulse 2s infinite;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* iOSã§ã®ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            position: relative;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ç”¨ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 6px;
            }

            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .tabs {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .tab {
                padding: 10px;
                font-size: 14px;
                flex-grow: 1;
                min-width: 80px;
                min-height: 44px; /* ã‚¿ãƒƒãƒé ˜åŸŸã®æœ€å°é«˜ã• */
            }

            .preset-container {
                flex-wrap: wrap;
            }

            .preset-btn {
                font-size: 12px;
                padding: 8px 10px;
                margin-bottom: 5px;
                flex-grow: 1;
                min-width: 100px;
                min-height: 44px; /* ã‚¿ãƒƒãƒã—ã‚„ã™ã */
            }

            button {
                min-height: 44px; /* ã‚¿ãƒƒãƒé ˜åŸŸã®æœ€å°é«˜ã• */
            }

            input, select {
                min-height: 44px; /* ã‚¿ãƒƒãƒé ˜åŸŸã®æœ€å°é«˜ã• */
                font-size: 16px; /* iOSã§ã‚ºãƒ¼ãƒ ã—ãªã„ãŸã‚ã®æœ€å°ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º */
            }

            /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
            .modal-content {
                width: 95%;
                padding: 15px;
                margin: 20px auto;
                max-height: 80vh;
            }

            /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ä½ç½®èª¿æ•´ */
            .theme-toggle {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }

            /* å±¥æ­´é …ç›®ã®èª¿æ•´ */
            .history-item {
                padding: 10px;
            }

            .history-item h4 {
                font-size: 16px;
            }

            .control-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .control-buttons-left,
            .control-buttons-right {
                width: 100%;
                justify-content: center;
            }

            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ */
            table {
                min-width: 600px; /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ€å°å¹…ã‚’è¨­å®š */
            }

            .mobile-swipe-hint {
                display: block; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®ã¿è¡¨ç¤º */
                margin-bottom: 10px;
            }

            /* ãƒ©ãƒ™ãƒ«ã‚’ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã */
            label {
                padding: 3px 0;
                margin-bottom: 8px;
            }

        }

        /* ã•ã‚‰ã«å°ã•ã„ç”»é¢ç”¨ã®èª¿æ•´ */
        @media screen and (max-width: 480px) {
            h1 {
                font-size: 24px;
                margin-bottom: 15px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
                margin-bottom: 15px;
            }

            .tab {
                border-radius: 0;
                margin-bottom: 1px;
                padding: 10px;
                font-size: 16px;
            }

            .tab:first-child {
                border-radius: 4px 4px 0 0;
            }

            .tab:last-child {
                border-radius: 0 0 4px 4px;
            }

            button {
                padding: 12px 15px;
                font-size: 16px;
                width: 100%;
                margin: 5px 0;
            }

            .control-buttons button {
                margin-right: 0;
            }

            .preset-btn {
                width: 100%;
                margin-right: 0;
                padding: 12px 10px;
                font-size: 16px;
                text-align: left;
            }

            .preset-container {
                flex-direction: column;
                gap: 8px;
            }

            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ãƒãƒ›è¡¨ç¤º */
            table {
                min-width: 480px; /* ã‚¹ãƒãƒ›ã®æ¨ªå¹…ã«åˆã‚ã›ã¦èª¿æ•´ */
                font-size: 14px;
            }

            th, td {
                padding: 6px 4px;
            }

            /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æœ€å¤§é«˜ã•ã‚’èª¿æ•´ */
            .modal-content {
                max-height: 90vh;
                width: 90%;
                padding: 15px 10px;
            }

            /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ãƒ•ã‚©ãƒ¼ãƒ ã®èª¿æ•´ */
            .add-preset-section .form-grid {
                grid-template-columns: 1fr;
            }

            /* è‚¥æ–™è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
            .add-fertilizer-btn {
                width: 100%;
                font-size: 18px;
                padding: 15px;
            }

            /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®ã‚¿ãƒƒãƒé ˜åŸŸæ‹¡å¤§ */
            input, select, button {
                touch-action: manipulation; /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã«ã‚ˆã‚‹ã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢ */
            }

            /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ä½™ç™½èª¿æ•´ */
            .form-group {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- ã‚¹ã‚­ãƒƒãƒ—ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <a href="#main-content" class="skip-link">ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã‚¹ã‚­ãƒƒãƒ—</a>

    <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ -->
    <button class="theme-toggle" id="themeToggle" aria-label="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã¨ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹">ğŸŒ“</button>

    <div class="container" role="main" id="main-content">
        <h1>è‚¥æ–™è¨ˆç®—æ©Ÿ</h1>
        
        <div class="fertilizer-presets">
            <div class="preset-actions">
                <h3 id="presets-heading">è‚¥æ–™ãƒ—ãƒªã‚»ãƒƒãƒˆ</h3>
                <button class="manage-presets-btn" onclick="openPresetsModal()" aria-label="ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†ç”»é¢ã‚’é–‹ã" aria-haspopup="dialog">ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†</button>
            </div>
            <div id="userPresetContainer" class="preset-container" role="group" aria-labelledby="presets-heading">
                <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã¯JavaScriptã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </div>
        </div>

        <div class="form-section" role="form" aria-labelledby="form-heading">
            <h2 id="form-heading" class="visually-hidden">è‚¥æ–™æƒ…å ±å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </h2>

            <div class="form-group">
                <label for="fertilizerName">è‚¥æ–™å:</label>
                <input type="text" id="fertilizerName" placeholder="ä¾‹: ç¡é…¸ã‚«ãƒª" aria-required="true">
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="nitrogenContent">çª’ç´  (N) å«æœ‰ç‡ (%):</label>
                    <input type="number" id="nitrogenContent" step="0.1" min="0" max="100" placeholder="ä¾‹: 13.5" aria-required="true">
                </div>

                <div class="form-group">
                    <label for="phosphorusContent">ãƒªãƒ³é…¸ (P) å«æœ‰ç‡ (%):</label>
                    <input type="number" id="phosphorusContent" step="0.1" min="0" max="100" placeholder="ä¾‹: 0" aria-required="true">
                </div>

                <div class="form-group">
                    <label for="potassiumContent">ã‚«ãƒªã‚¦ãƒ  (K) å«æœ‰ç‡ (%):</label>
                    <input type="number" id="potassiumContent" step="0.1" min="0" max="100" placeholder="ä¾‹: 46.3" aria-required="true">
                </div>
            </div>

            <button type="button" class="toggle-section" onclick="toggleAdvancedFields()" aria-expanded="false" aria-controls="advancedFields">â–¼ å¾®é‡è¦ç´ ã®å…¥åŠ›ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º/éè¡¨ç¤ºï¼‰</button>
            
            <div id="advancedFields" aria-labelledby="advanced-heading">
                <h3 id="advanced-heading" class="visually-hidden">å¾®é‡è¦ç´ ã®å…¥åŠ›</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="calciumContent">ã‚«ãƒ«ã‚·ã‚¦ãƒ  (Ca) å«æœ‰ç‡ (%):</label>
                        <input type="number" id="calciumContent" step="0.1" min="0" max="100" placeholder="ä¾‹: 0" aria-describedby="ca-desc">
                        <span id="ca-desc" class="visually-hidden">ã‚«ãƒ«ã‚·ã‚¦ãƒ å«æœ‰ç‡ã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã§å…¥åŠ›ã—ã¦ãã ã•ã„</span>
                    </div>

                    <div class="form-group">
                        <label for="magnesiumContent">ãƒã‚°ãƒã‚·ã‚¦ãƒ  (Mg) å«æœ‰ç‡ (%):</label>
                        <input type="number" id="magnesiumContent" step="0.1" min="0" max="100" placeholder="ä¾‹: 0" aria-describedby="mg-desc">
                        <span id="mg-desc" class="visually-hidden">ãƒã‚°ãƒã‚·ã‚¦ãƒ å«æœ‰ç‡ã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã§å…¥åŠ›ã—ã¦ãã ã•ã„</span>
                    </div>

                    <div class="form-group">
                        <label for="sulfurContent">ç¡«é»„ (S) å«æœ‰ç‡ (%):</label>
                        <input type="number" id="sulfurContent" step="0.1" min="0" max="100" placeholder="ä¾‹: 0" aria-describedby="s-desc">
                        <span id="s-desc" class="visually-hidden">ç¡«é»„å«æœ‰ç‡ã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã§å…¥åŠ›ã—ã¦ãã ã•ã„</span>
                    </div>

                    <div class="form-group">
                        <label for="ironContent">é‰„ (Fe) å«æœ‰ç‡ (%):</label>
                        <input type="number" id="ironContent" step="0.01" min="0" max="100" placeholder="ä¾‹: 0" aria-describedby="fe-desc">
                        <span id="fe-desc" class="visually-hidden">é‰„å«æœ‰ç‡ã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã§å…¥åŠ›ã—ã¦ãã ã•ã„</span>
                    </div>

                    <div class="form-group">
                        <label for="manganeseContent">ãƒãƒ³ã‚¬ãƒ³ (Mn) å«æœ‰ç‡ (%):</label>
                        <input type="number" id="manganeseContent" step="0.01" min="0" max="100" placeholder="ä¾‹: 0" aria-describedby="mn-desc">
                        <span id="mn-desc" class="visually-hidden">ãƒãƒ³ã‚¬ãƒ³å«æœ‰ç‡ã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã§å…¥åŠ›ã—ã¦ãã ã•ã„</span>
                    </div>

                    <div class="form-group">
                        <label for="zincContent">äºœé‰› (Zn) å«æœ‰ç‡ (%):</label>
                        <input type="number" id="zincContent" step="0.01" min="0" max="100" placeholder="ä¾‹: 0" aria-describedby="zn-desc">
                        <span id="zn-desc" class="visually-hidden">äºœé‰›å«æœ‰ç‡ã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã§å…¥åŠ›ã—ã¦ãã ã•ã„</span>
                    </div>

                    <div class="form-group">
                        <label for="boronContent">ãƒ›ã‚¦ç´  (B) å«æœ‰ç‡ (%):</label>
                        <input type="number" id="boronContent" step="0.01" min="0" max="100" placeholder="ä¾‹: 0" aria-describedby="b-desc">
                        <span id="b-desc" class="visually-hidden">ãƒ›ã‚¦ç´ å«æœ‰ç‡ã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã§å…¥åŠ›ã—ã¦ãã ã•ã„</span>
                    </div>

                    <div class="form-group">
                        <label for="otherContent">ãã®ä»–ã®è¦ç´  (ä»»æ„):</label>
                        <input type="text" id="otherContent" placeholder="ä¾‹: Cu 0.5%, Mo 0.1%" aria-describedby="other-desc">
                        <span id="other-desc" class="visually-hidden">ãã®ä»–ã®å¾®é‡è¦ç´ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰</span>
                    </div>
                </div>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label for="amount">ä½¿ç”¨é‡:</label>
                <div style="display: flex; gap: 10px;" role="group" aria-labelledby="amount-group">
                    <span id="amount-group" class="visually-hidden">è‚¥æ–™ã®ä½¿ç”¨é‡ã¨å˜ä½</span>
                    <input type="number" id="amount" step="0.1" min="0" placeholder="ä¾‹: 100" style="flex: 3;" aria-required="true">
                    <select id="amountUnit" style="flex: 1;" aria-label="ä½¿ç”¨é‡ã®å˜ä½">
                        <option value="g">g</option>
                        <option value="kg">kg</option>
                    </select>
                </div>
            </div>

            <div class="button-spacer">
                <button class="add-fertilizer-btn" onclick="addFertilizer()" aria-label="ç¾åœ¨å…¥åŠ›ã—ã¦ã„ã‚‹è‚¥æ–™ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹">è‚¥æ–™ã‚’è¿½åŠ </button>
            </div>
        </div>
        
        <div class="tabs" role="tablist" aria-label="è‚¥æ–™è¨ˆç®—ã‚¿ãƒ–">
            <button
                class="tab active"
                id="fertilizerTab-btn"
                onclick="switchTab('fertilizerTab')"
                role="tab"
                aria-selected="true"
                aria-controls="fertilizerTab">
                è‚¥æ–™ãƒªã‚¹ãƒˆ
            </button>
            <button
                class="tab"
                id="resultsTab-btn"
                onclick="switchTab('resultsTab')"
                role="tab"
                aria-selected="false"
                aria-controls="resultsTab">
                è¨ˆç®—çµæœ
            </button>
            <button
                class="tab"
                id="historyTab-btn"
                onclick="switchTab('historyTab')"
                role="tab"
                aria-selected="false"
                aria-controls="historyTab">
                è¨ˆç®—å±¥æ­´
            </button>
        </div>
        
        <div id="fertilizerTab" class="tab-content active" role="tabpanel" aria-labelledby="fertilizerTab-btn">
            <div class="fertilizers-list">
                <h3 id="fertilizers-heading">è¿½åŠ ã•ã‚ŒãŸè‚¥æ–™</h3>
                <div class="table-responsive">
                    <table id="fertilizerTable" aria-labelledby="fertilizers-heading">
                        <caption class="visually-hidden">è¿½åŠ ã•ã‚ŒãŸè‚¥æ–™ã®ä¸€è¦§</caption>
                        <thead>
                            <tr>
                                <th scope="col">è‚¥æ–™å</th>
                                <th scope="col">N (%)</th>
                                <th scope="col">P (%)</th>
                                <th scope="col">K (%)</th>
                                <th scope="col">Ca (%)</th>
                                <th scope="col">Mg (%)</th>
                                <th scope="col">S (%)</th>
                                <th scope="col">ä½¿ç”¨é‡</th>
                                <th scope="col">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="fertilizerList">
                            <!-- è‚¥æ–™ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                        </tbody>
                    </table>
                </div>
                <p class="mobile-swipe-hint">â† æ¨ªã«ã‚¹ãƒ¯ã‚¤ãƒ—ã§ãã¾ã™ â†’</p>
            </div>
        </div>

        <div id="resultsTab" class="tab-content" role="tabpanel" aria-labelledby="resultsTab-btn" hidden>
            <div class="results" id="resultsSection">
                <h2 id="results-heading">è¨ˆç®—çµæœ</h2>
                <div id="calculationResults" aria-live="polite" aria-atomic="true">
                    <!-- è¨ˆç®—çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    <p>ã¾ã è‚¥æ–™ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                </div>
            </div>
        </div>

        <div id="historyTab" class="tab-content" role="tabpanel" aria-labelledby="historyTab-btn" hidden>
            <div class="results">
                <h2 id="history-heading">è¨ˆç®—å±¥æ­´</h2>
                <div id="historyList" aria-live="polite" aria-labelledby="history-heading">
                    <!-- è¨ˆç®—å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    <div class="history-empty" role="status">è¨ˆç®—å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                </div>
            </div>
        </div>
        
        <div class="control-buttons">
            <div class="control-buttons-left">
                <button onclick="calculateResults()" aria-label="å…¥åŠ›ã•ã‚ŒãŸè‚¥æ–™ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰çµæœã‚’è¨ˆç®—ã™ã‚‹">çµæœã‚’è¨ˆç®—</button>
                <button class="history-btn" onclick="switchTab('historyTab')" aria-label="è¨ˆç®—å±¥æ­´ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã‚‹">å±¥æ­´ã‚’è¡¨ç¤º</button>
            </div>
            <div class="control-buttons-right">
                <button onclick="resetCalculator()" style="background-color: #e74c3c;" aria-label="å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹" aria-describedby="reset-desc">ãƒªã‚»ãƒƒãƒˆ</button>
                <span id="reset-desc" class="visually-hidden">è­¦å‘Šï¼šã“ã®æ“ä½œã¯å…¥åŠ›ã•ã‚ŒãŸã™ã¹ã¦ã®è‚¥æ–™ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™</span>
            </div>
        </div>
    </div>

    <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="presetsModal" class="modal" role="dialog" aria-labelledby="presets-modal-title" aria-modal="true" aria-hidden="true">
        <div class="modal-content">
            <button class="close-modal" onclick="closePresetsModal()" aria-label="ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†ç”»é¢ã‚’é–‰ã˜ã‚‹">&times;</button>
            <h2 id="presets-modal-title">ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†</h2>
            
            <div class="preset-settings">
                <div class="preset-section">
                    <h3 id="default-presets-heading">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆè¡¨ç¤º/éè¡¨ç¤ºã®é¸æŠï¼‰</h3>
                    <div id="defaultPresetList" role="region" aria-labelledby="default-presets-heading">
                        <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>

                <div class="preset-section">
                    <h3 id="custom-presets-heading">ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆè¿½åŠ ãƒ»å‰Šé™¤å¯èƒ½ï¼‰</h3>
                    <div id="userPresetList" role="region" aria-labelledby="custom-presets-heading">
                        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>

                <div class="add-preset-section">
                    <h3 id="add-preset-heading">æ–°ã—ã„ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’è¿½åŠ </h3>
                    <div role="form" aria-labelledby="add-preset-heading">
                        <div class="form-group">
                            <label for="newPresetName">è‚¥æ–™å:</label>
                            <input type="text" id="newPresetName" placeholder="ä¾‹: ãƒã‚¤è‚¥æ–™" aria-required="true">
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="newPresetN">çª’ç´  (N) %:</label>
                                <input type="number" id="newPresetN" step="0.1" min="0" max="100" aria-required="true">
                            </div>

                            <div class="form-group">
                                <label for="newPresetP">ãƒªãƒ³é…¸ (P) %:</label>
                                <input type="number" id="newPresetP" step="0.1" min="0" max="100" aria-required="true">
                            </div>

                            <div class="form-group">
                                <label for="newPresetK">ã‚«ãƒªã‚¦ãƒ  (K) %:</label>
                                <input type="number" id="newPresetK" step="0.1" min="0" max="100" aria-required="true">
                            </div>

                            <div class="form-group">
                                <label for="newPresetCa">ã‚«ãƒ«ã‚·ã‚¦ãƒ  (Ca) %:</label>
                                <input type="number" id="newPresetCa" step="0.1" min="0" max="100">
                            </div>

                            <div class="form-group">
                                <label for="newPresetMg">ãƒã‚°ãƒã‚·ã‚¦ãƒ  (Mg) %:</label>
                                <input type="number" id="newPresetMg" step="0.1" min="0" max="100">
                            </div>

                            <div class="form-group">
                                <label for="newPresetS">ç¡«é»„ (S) %:</label>
                                <input type="number" id="newPresetS" step="0.1" min="0" max="100">
                            </div>

                            <div class="form-group">
                                <label for="newPresetFe">é‰„ (Fe) %:</label>
                                <input type="number" id="newPresetFe" step="0.01" min="0" max="100">
                            </div>

                            <div class="form-group">
                                <label for="newPresetMn">ãƒãƒ³ã‚¬ãƒ³ (Mn) %:</label>
                                <input type="number" id="newPresetMn" step="0.01" min="0" max="100">
                            </div>

                            <div class="form-group">
                                <label for="newPresetZn">äºœé‰› (Zn) %:</label>
                                <input type="number" id="newPresetZn" step="0.01" min="0" max="100">
                            </div>

                            <div class="form-group">
                                <label for="newPresetB">ãƒ›ã‚¦ç´  (B) %:</label>
                                <input type="number" id="newPresetB" step="0.01" min="0" max="100">
                            </div>
                        </div>

                        <button class="save-btn" onclick="addNewPreset()" aria-label="å…¥åŠ›ã—ãŸãƒ‡ãƒ¼ã‚¿ã§æ–°ã—ã„ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’è¿½åŠ ">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’è¿½åŠ </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è‚¥æ–™ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹é…åˆ—
        let fertilizers = [];
        
        // è¨ˆç®—å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹é…åˆ—
        let calculationHistory = [];
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆ
        const defaultPresets = [
            { id: 'd1', name: 'ç¡é…¸ã‚«ãƒª', nitrogen: 13.5, phosphorus: 0, potassium: 46.3, calcium: 0, magnesium: 0, sulfur: 0, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true },
            { id: 'd2', name: 'ç¡é…¸ã‚¢ãƒ³ãƒ¢ãƒ‹ã‚¦ãƒ ', nitrogen: 34, phosphorus: 0, potassium: 0, calcium: 0, magnesium: 0, sulfur: 0, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true },
            { id: 'd3', name: 'ç‡å®‰', nitrogen: 18, phosphorus: 46, potassium: 0, calcium: 0, magnesium: 0, sulfur: 0, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true },
            { id: 'd4', name: 'å°¿ç´ ', nitrogen: 46, phosphorus: 0, potassium: 0, calcium: 0, magnesium: 0, sulfur: 0, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true },
            { id: 'd5', name: 'ç¡«å®‰', nitrogen: 21, phosphorus: 0, potassium: 0, calcium: 0, magnesium: 0, sulfur: 24, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true },
            { id: 'd6', name: 'å¡©åŒ–ã‚«ãƒª', nitrogen: 0, phosphorus: 0, potassium: 60, calcium: 0, magnesium: 0, sulfur: 0, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true },
            { id: 'd7', name: 'ç¡«é…¸ã‚«ãƒª', nitrogen: 0, phosphorus: 0, potassium: 50, calcium: 0, magnesium: 0, sulfur: 18, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true },
            { id: 'd8', name: 'éãƒªãƒ³é…¸çŸ³ç°', nitrogen: 0, phosphorus: 20, potassium: 0, calcium: 15, magnesium: 0, sulfur: 0, iron: 0, manganese: 0, zinc: 0, boron: 0, isVisible: true }
        ];
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ãƒ—ãƒªã‚»ãƒƒãƒˆ
        let userPresets = [];
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è¨­å®šã‚’èª­ã¿è¾¼ã‚€
        window.onload = function() {
            loadSettings();
            loadHistory();
            renderPresets();
            renderHistoryList();
        };
        
        // è¨­å®šã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã‚€
        function loadSettings() {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆã®è¡¨ç¤ºè¨­å®šã‚’èª­ã¿è¾¼ã‚€
            const savedDefaultPresets = localStorage.getItem('defaultPresets');
            if (savedDefaultPresets) {
                const parsedDefaults = JSON.parse(savedDefaultPresets);
                
                // æ—¢å­˜ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
                defaultPresets.forEach(preset => {
                    const savedPreset = parsedDefaults.find(p => p.id === preset.id);
                    if (savedPreset) {
                        preset.isVisible = savedPreset.isVisible;
                    }
                });
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã‚€
            const savedUserPresets = localStorage.getItem('userPresets');
            if (savedUserPresets) {
                userPresets = JSON.parse(savedUserPresets);
            }
        }
        
        // è¨ˆç®—å±¥æ­´ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã‚€
        function loadHistory() {
            const savedHistory = localStorage.getItem('calculationHistory');
            if (savedHistory) {
                calculationHistory = JSON.parse(savedHistory);
            }
        }
        
        // è¨­å®šã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
        function saveSettings() {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆã®è¡¨ç¤ºè¨­å®šã‚’ä¿å­˜
            const defaultSettings = defaultPresets.map(preset => ({
                id: preset.id,
                isVisible: preset.isVisible
            }));
            localStorage.setItem('defaultPresets', JSON.stringify(defaultSettings));
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä¿å­˜
            localStorage.setItem('userPresets', JSON.stringify(userPresets));
        }
        
        // è¨ˆç®—å±¥æ­´ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
        function saveHistory() {
            localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));
        }
        
        // è¨ˆç®—çµæœã‚’å±¥æ­´ã«è¿½åŠ 
        function addToHistory(result) {
            // ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—
            const now = new Date();
            const timestamp = now.toLocaleString('ja-JP');
            
            // è‚¥æ–™ãƒªã‚¹ãƒˆã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
            const fertilizersCopy = JSON.parse(JSON.stringify(fertilizers));
            
            // å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’ä½œæˆ
            const historyEntry = {
                id: Date.now(),
                timestamp: timestamp,
                result: result,
                fertilizers: fertilizersCopy
            };
            
            // å±¥æ­´ã®å…ˆé ­ã«è¿½åŠ 
            calculationHistory.unshift(historyEntry);
            
            // å±¥æ­´ã‚’10ä»¶ã«åˆ¶é™
            if (calculationHistory.length > 10) {
                calculationHistory = calculationHistory.slice(0, 10);
            }
            
            // å±¥æ­´ã‚’ä¿å­˜
            saveHistory();
            
            // å±¥æ­´ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            renderHistoryList();
        }
        
        // å±¥æ­´ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        function renderHistoryList() {
            const historyList = document.getElementById('historyList');

            // å±¥æ­´ãŒãªã„å ´åˆ
            if (calculationHistory.length === 0) {
                historyList.innerHTML = '<div class="history-empty" role="status">è¨ˆç®—å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // å±¥æ­´ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
            historyList.innerHTML = '';

            calculationHistory.forEach((entry, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.setAttribute('role', 'button');
                historyItem.setAttribute('tabindex', '0');
                historyItem.setAttribute('aria-label', `è¨ˆç®—çµæœ ${calculationHistory.length - index} ã‚’èª­ã¿è¾¼ã‚€`);

                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¨ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã®ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ
                historyItem.onclick = function() {
                    loadHistoryEntry(index);
                };
                historyItem.onkeydown = function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault(); // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²æ­¢
                        loadHistoryEntry(index);
                    }
                };

                // è‚¥æ–™åã‚’å–å¾—
                let fertilizerNames = entry.fertilizers.map(f => f.name).join(', ');
                if (fertilizerNames.length > 50) {
                    fertilizerNames = fertilizerNames.substring(0, 50) + '...';
                }

                // NPKæ¯”ç‡ã‚’æŠ½å‡º
                const npkRatio = `${entry.result.finalN.toFixed(1)}-${entry.result.finalP.toFixed(1)}-${entry.result.finalK.toFixed(1)}`;

                historyItem.innerHTML = `
                    <h4>è¨ˆç®—çµæœ #${calculationHistory.length - index}</h4>
                    <div class="npk-ratio">NPKæ¯”ç‡: ${npkRatio}</div>
                    <div>ä½¿ç”¨è‚¥æ–™: ${fertilizerNames}</div>
                    <div class="timestamp">${entry.timestamp}</div>
                `;

                historyList.appendChild(historyItem);
            });
        }
        
        // å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚’èª­ã¿è¾¼ã‚€
        function loadHistoryEntry(index) {
            const entry = calculationHistory[index];
            
            // è‚¥æ–™ãƒªã‚¹ãƒˆã‚’å¾©å…ƒ
            fertilizers = JSON.parse(JSON.stringify(entry.fertilizers));
            
            // è‚¥æ–™ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            updateFertilizerList();
            
            // è¨ˆç®—çµæœã‚’è¡¨ç¤º
            displaySavedResult(entry.result);
            
            // çµæœã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
            switchTab('resultsTab');
        }
        
        // ä¿å­˜ã•ã‚ŒãŸçµæœã‚’è¡¨ç¤º
        function displaySavedResult(result) {
            const resultsDiv = document.getElementById('calculationResults');
            resultsDiv.innerHTML = `
                <h3>ä¸»è¦æˆåˆ†</h3>
                <table>
                    <tr>
                        <th>ç·ä½¿ç”¨é‡</th>
                        <th>çª’ç´  (N)</th>
                        <th>ãƒªãƒ³é…¸ (P)</th>
                        <th>ã‚«ãƒªã‚¦ãƒ  (K)</th>
                    </tr>
                    <tr>
                        <td>${result.totalAmount >= 1000 ? (result.totalAmount / 1000).toFixed(2) + ' kg' : result.totalAmount.toFixed(1) + ' g'}</td>
                        <td>${result.totalN.toFixed(2)} g (${result.finalN.toFixed(2)}%)</td>
                        <td>${result.totalP.toFixed(2)} g (${result.finalP.toFixed(2)}%)</td>
                        <td>${result.totalK.toFixed(2)} g (${result.finalK.toFixed(2)}%)</td>
                    </tr>
                </table>
                
                <h3>äºŒæ¬¡æ „é¤Šç´ </h3>
                <table>
                    <tr>
                        <th>ã‚«ãƒ«ã‚·ã‚¦ãƒ  (Ca)</th>
                        <th>ãƒã‚°ãƒã‚·ã‚¦ãƒ  (Mg)</th>
                        <th>ç¡«é»„ (S)</th>
                    </tr>
                    <tr>
                        <td>${result.totalCa.toFixed(2)} g (${result.finalCa.toFixed(2)}%)</td>
                        <td>${result.totalMg.toFixed(2)} g (${result.finalMg.toFixed(2)}%)</td>
                        <td>${result.totalS.toFixed(2)} g (${result.finalS.toFixed(2)}%)</td>
                    </tr>
                </table>
                
                <h3>å¾®é‡æ „é¤Šç´ </h3>
                <table>
                    <tr>
                        <th>é‰„ (Fe)</th>
                        <th>ãƒãƒ³ã‚¬ãƒ³ (Mn)</th>
                        <th>äºœé‰› (Zn)</th>
                        <th>ãƒ›ã‚¦ç´  (B)</th>
                    </tr>
                    <tr>
                        <td>${result.totalFe.toFixed(2)} g (${result.finalFe.toFixed(3)}%)</td>
                        <td>${result.totalMn.toFixed(2)} g (${result.finalMn.toFixed(3)}%)</td>
                        <td>${result.totalZn.toFixed(2)} g (${result.finalZn.toFixed(3)}%)</td>
                        <td>${result.totalB.toFixed(2)} g (${result.finalB.toFixed(3)}%)</td>
                    </tr>
                </table>
                
                <h3>æœ€çµ‚NPKæ¯”ç‡: ${result.finalN.toFixed(1)}-${result.finalP.toFixed(1)}-${result.finalK.toFixed(1)}</h3>
                <p>â€» æ³¨æ„: ã“ã‚Œã¯è‚¥æ–™ã®æ··åˆç·é‡é‡ã«å¯¾ã™ã‚‹å„æˆåˆ†ã®å‰²åˆã§ã™ã€‚</p>
                <p><em>â€» ã“ã®çµæœã¯å±¥æ­´ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ</em></p>
            `;
        }
        
        // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’æç”»ã™ã‚‹
        function renderPresets() {
            const container = document.getElementById('userPresetContainer');
            container.innerHTML = '';

            // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã®ãŸã‚ã«ãƒ—ãƒªã‚»ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®èª¬æ˜ã‚’è¿½åŠ 
            if (container.getAttribute('aria-describedby') !== 'preset-description') {
                const description = document.createElement('div');
                description.id = 'preset-description';
                description.className = 'visually-hidden';
                description.textContent = 'ã“ã‚Œã‚‰ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å¯¾å¿œã™ã‚‹è‚¥æ–™ã®æƒ…å ±ãŒå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ã€‚';
                container.setAttribute('aria-describedby', 'preset-description');

                // èª¬æ˜ã‚’ãƒšãƒ¼ã‚¸ã«è¿½åŠ ï¼ˆã‚³ãƒ³ãƒ†ãƒŠã®å‰ï¼‰
                container.parentNode.insertBefore(description, container);
            }

            // è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆ
            defaultPresets.filter(preset => preset.isVisible).forEach(preset => {
                const displayName = getPresetDisplayName(preset);
                const btn = document.createElement('button');
                btn.className = 'preset-btn';
                btn.textContent = displayName;
                btn.setAttribute('aria-label', `${preset.name}ã‚’é¸æŠ: çª’ç´ ${preset.nitrogen}%, ãƒªãƒ³é…¸${preset.phosphorus}%, ã‚«ãƒªã‚¦ãƒ ${preset.potassium}%`);
                btn.onclick = function() {
                    addPreset(
                        preset.name,
                        preset.nitrogen,
                        preset.phosphorus,
                        preset.potassium,
                        preset.calcium,
                        preset.magnesium,
                        preset.sulfur,
                        preset.iron,
                        preset.manganese,
                        preset.zinc,
                        preset.boron
                    );
                };
                container.appendChild(btn);
            });

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒªã‚»ãƒƒãƒˆ
            userPresets.forEach(preset => {
                const displayName = getPresetDisplayName(preset);
                const btn = document.createElement('button');
                btn.className = 'preset-btn';
                btn.textContent = displayName;
                btn.setAttribute('aria-label', `${preset.name}ã‚’é¸æŠ: çª’ç´ ${preset.nitrogen}%, ãƒªãƒ³é…¸${preset.phosphorus}%, ã‚«ãƒªã‚¦ãƒ ${preset.potassium}%`);
                btn.setAttribute('data-preset-type', 'user');
                btn.onclick = function() {
                    addPreset(
                        preset.name,
                        preset.nitrogen,
                        preset.phosphorus,
                        preset.potassium,
                        preset.calcium,
                        preset.magnesium,
                        preset.sulfur,
                        preset.iron,
                        preset.manganese,
                        preset.zinc,
                        preset.boron
                    );
                };
                container.appendChild(btn);
            });

            // ãƒ—ãƒªã‚»ãƒƒãƒˆãŒä¸€ã¤ã‚‚ãªã„å ´åˆ
            if (container.children.length === 0) {
                const noPresets = document.createElement('p');
                noPresets.textContent = 'è¡¨ç¤ºã™ã‚‹ãƒ—ãƒªã‚»ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†ã‹ã‚‰è¨­å®šã§ãã¾ã™ã€‚';
                noPresets.setAttribute('role', 'status');
                container.appendChild(noPresets);
            }
        }
        
        // ãƒ—ãƒªã‚»ãƒƒãƒˆã®è¡¨ç¤ºåã‚’ç”Ÿæˆ
        function getPresetDisplayName(preset) {
            let name = preset.name;
            
            // NPKå€¤ã‚’è¿½åŠ 
            const npk = `(${preset.nitrogen}-${preset.phosphorus}-${preset.potassium}`;
            
            // NPKä»¥å¤–ã®ä¸»è¦ãªæˆåˆ†ã‚’è¿½åŠ 
            const extras = [];
            if (preset.calcium > 0) extras.push(`Ca${preset.calcium}`);
            if (preset.magnesium > 0) extras.push(`Mg${preset.magnesium}`);
            if (preset.sulfur > 0) extras.push(`S${preset.sulfur}`);
            
            // è¿½åŠ æˆåˆ†ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
            const extrasText = extras.length > 0 ? '+' + extras.join(',') : '';
            
            return `${name} ${npk}${extrasText})`;
        }
        
        // ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openPresetsModal() {
            const modal = document.getElementById('presetsModal');
            modal.style.display = 'block';
            modal.setAttribute('aria-hidden', 'false');

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸã¨ãã«æœ€åˆã®è¦ç´ ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»å‹•
            const closeButton = modal.querySelector('.close-modal');

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«å°‘ã—é…å»¶ã•ã›ã‚‹
            setTimeout(() => {
                modal.classList.add('show');
                // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒˆãƒ©ãƒƒãƒ—ã®ãŸã‚ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»å‹•
                if (closeButton) {
                    closeButton.focus();
                }
            }, 10);

            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå‰ã«å†…å®¹ã‚’æ›´æ–°
            renderPresetLists();

            // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
            document.addEventListener('keydown', handleEscapeKey);
        }

        // ãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closePresetsModal() {
            const modal = document.getElementById('presetsModal');
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');

            // ESCã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
            document.removeEventListener('keydown', handleEscapeKey);

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å¾Œã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            setTimeout(() => {
                modal.style.display = 'none';

                // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å…ƒã®ã€Œãƒ—ãƒªã‚»ãƒƒãƒˆç®¡ç†ã€ãƒœã‚¿ãƒ³ã«æˆ»ã™
                const presetManageBtn = document.querySelector('.manage-presets-btn');
                if (presetManageBtn) {
                    presetManageBtn.focus();
                }
            }, 300);
        }

        // ESCã‚­ãƒ¼ã‚’æŠ¼ã—ãŸã¨ãã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function handleEscapeKey(e) {
            if (e.key === 'Escape') {
                closePresetsModal();
            }
        }
        
        // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹
        function renderPresetLists() {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ
            const defaultList = document.getElementById('defaultPresetList');
            defaultList.innerHTML = '';

            defaultPresets.forEach((preset, index) => {
                const item = document.createElement('div');
                item.className = 'preset-item default-preset-item';

                const label = document.createElement('label');
                label.className = 'checkbox-label';
                label.setAttribute('for', `default-preset-${index}`);

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `default-preset-${index}`;
                checkbox.checked = preset.isVisible;
                checkbox.setAttribute('aria-label', `${preset.name}ã‚’è¡¨ç¤ºã™ã‚‹`);
                checkbox.onchange = function() {
                    preset.isVisible = checkbox.checked;
                    saveSettings();
                    renderPresets();

                    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ç”¨ã®çŠ¶æ…‹é€šçŸ¥
                    const status = document.createElement('div');
                    status.setAttribute('role', 'status');
                    status.className = 'visually-hidden';
                    status.textContent = `${preset.name}ã‚’${checkbox.checked ? 'è¡¨ç¤º' : 'éè¡¨ç¤º'}ã«è¨­å®šã—ã¾ã—ãŸ`;
                    document.body.appendChild(status);

                    // ä¸€å®šæ™‚é–“å¾Œã«é€šçŸ¥ã‚’å‰Šé™¤
                    setTimeout(() => {
                        document.body.removeChild(status);
                    }, 1000);
                };

                const displayName = document.createElement('span');
                displayName.textContent = getPresetDisplayName(preset);

                label.appendChild(checkbox);
                label.appendChild(displayName);

                // èª¬æ˜ã‚’è¿½åŠ 
                const description = document.createElement('small');
                description.textContent = 'ï¼ˆè¡¨ç¤º/éè¡¨ç¤ºã®ã¿å¤‰æ›´å¯èƒ½ï¼‰';
                description.style.marginLeft = '10px';
                description.style.color = '#777';
                description.setAttribute('aria-hidden', 'true'); // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ã§ã¯å†—é•·ãªã®ã§éè¡¨ç¤º

                item.appendChild(label);
                label.appendChild(description);
                defaultList.appendChild(item);
            });

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ
            const userList = document.getElementById('userPresetList');
            userList.innerHTML = '';

            if (userPresets.length === 0) {
                const emptyMessage = document.createElement('p');
                emptyMessage.textContent = 'ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒªã‚»ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã§ãã¾ã™ã€‚';
                emptyMessage.setAttribute('role', 'status');
                userList.appendChild(emptyMessage);
            } else {
                userPresets.forEach((preset, index) => {
                    const item = document.createElement('div');
                    item.className = 'preset-item';

                    const name = document.createElement('span');
                    name.textContent = getPresetDisplayName(preset);

                    const actions = document.createElement('div');
                    actions.className = 'preset-item-actions';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = 'å‰Šé™¤';
                    deleteBtn.setAttribute('aria-label', `${preset.name}ã‚’å‰Šé™¤ã™ã‚‹`);
                    deleteBtn.onclick = function() {
                        if (confirm(`"${preset.name}"ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                            userPresets.splice(index, 1);
                            saveSettings();
                            renderPresetLists();
                            renderPresets();

                            // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ç”¨ã®çŠ¶æ…‹é€šçŸ¥
                            const status = document.createElement('div');
                            status.setAttribute('role', 'status');
                            status.className = 'visually-hidden';
                            status.textContent = `${preset.name}ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ`;
                            document.body.appendChild(status);

                            // ä¸€å®šæ™‚é–“å¾Œã«é€šçŸ¥ã‚’å‰Šé™¤
                            setTimeout(() => {
                                document.body.removeChild(status);
                            }, 1000);
                        }
                    };

                    actions.appendChild(deleteBtn);

                    item.appendChild(name);
                    item.appendChild(actions);
                    userList.appendChild(item);
                });
            }
        }
        
        // æ–°ã—ã„ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’è¿½åŠ 
        function addNewPreset() {
            const name = document.getElementById('newPresetName').value;
            const n = parseFloat(document.getElementById('newPresetN').value) || 0;
            const p = parseFloat(document.getElementById('newPresetP').value) || 0;
            const k = parseFloat(document.getElementById('newPresetK').value) || 0;
            const ca = parseFloat(document.getElementById('newPresetCa').value) || 0;
            const mg = parseFloat(document.getElementById('newPresetMg').value) || 0;
            const s = parseFloat(document.getElementById('newPresetS').value) || 0;
            const fe = parseFloat(document.getElementById('newPresetFe').value) || 0;
            const mn = parseFloat(document.getElementById('newPresetMn').value) || 0;
            const zn = parseFloat(document.getElementById('newPresetZn').value) || 0;
            const b = parseFloat(document.getElementById('newPresetB').value) || 0;
            
            if (!name) {
                alert('è‚¥æ–™åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // æ–°ã—ã„ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä½œæˆ
            const newPreset = {
                id: 'u' + Date.now(),  // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’ç”Ÿæˆ
                name,
                nitrogen: n,
                phosphorus: p,
                potassium: k,
                calcium: ca,
                magnesium: mg,
                sulfur: s,
                iron: fe,
                manganese: mn,
                zinc: zn,
                boron: b
            };
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒªã‚»ãƒƒãƒˆã«è¿½åŠ 
            userPresets.push(newPreset);
            
            // è¨­å®šã‚’ä¿å­˜
            saveSettings();
            
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            clearNewPresetFields();
            
            // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            renderPresetLists();
            renderPresets();
            
            alert('æ–°ã—ã„ãƒ—ãƒªã‚»ãƒƒãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ');
        }
        
        // æ–°ã—ã„ãƒ—ãƒªã‚»ãƒƒãƒˆå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
        function clearNewPresetFields() {
            document.getElementById('newPresetName').value = '';
            document.getElementById('newPresetN').value = '';
            document.getElementById('newPresetP').value = '';
            document.getElementById('newPresetK').value = '';
            document.getElementById('newPresetCa').value = '';
            document.getElementById('newPresetMg').value = '';
            document.getElementById('newPresetS').value = '';
            document.getElementById('newPresetFe').value = '';
            document.getElementById('newPresetMn').value = '';
            document.getElementById('newPresetZn').value = '';
            document.getElementById('newPresetB').value = '';
        }
        
        // è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleAdvancedFields() {
            const advancedFields = document.getElementById('advancedFields');
            const toggleButton = document.querySelector('.toggle-section');

            if (advancedFields.style.display === 'none' || advancedFields.style.display === '') {
                advancedFields.style.display = 'block';

                // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å±æ€§ã‚’æ›´æ–°
                toggleButton.setAttribute('aria-expanded', 'true');
                toggleButton.textContent = 'â–² å¾®é‡è¦ç´ ã®å…¥åŠ›ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º/éè¡¨ç¤ºï¼‰';

                // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æœ€åˆã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ç§»å‹•
                const firstInput = advancedFields.querySelector('input');
                if (firstInput) {
                    firstInput.focus();
                }
            } else {
                advancedFields.style.display = 'none';

                // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å±æ€§ã‚’æ›´æ–°
                toggleButton.setAttribute('aria-expanded', 'false');
                toggleButton.textContent = 'â–¼ å¾®é‡è¦ç´ ã®å…¥åŠ›ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º/éè¡¨ç¤ºï¼‰';
            }
        }
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabId) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
                content.setAttribute('hidden', 'true');
                content.setAttribute('aria-hidden', 'true');
            });

            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });

            // é¸æŠã—ãŸã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            const activeContent = document.getElementById(tabId);
            activeContent.classList.add('active');
            activeContent.removeAttribute('hidden');
            activeContent.setAttribute('aria-hidden', 'false');

            const activeTabBtn = document.getElementById(tabId + '-btn');
            activeTabBtn.classList.add('active');
            activeTabBtn.setAttribute('aria-selected', 'true');
            activeTabBtn.focus(); // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç¶­æŒ
        }
        
        // ãƒ—ãƒªã‚»ãƒƒãƒˆè‚¥æ–™ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
        function addPreset(name, n, p, k, ca, mg, s, fe, mn, zn, b) {
            document.getElementById('fertilizerName').value = name;
            document.getElementById('nitrogenContent').value = n;
            document.getElementById('phosphorusContent').value = p;
            document.getElementById('potassiumContent').value = k;
            document.getElementById('calciumContent').value = ca;
            document.getElementById('magnesiumContent').value = mg;
            document.getElementById('sulfurContent').value = s;
            document.getElementById('ironContent').value = fe;
            document.getElementById('manganeseContent').value = mn;
            document.getElementById('zincContent').value = zn;
            document.getElementById('boronContent').value = b;
            document.getElementById('otherContent').value = '';
            document.getElementById('amount').focus();
        }
        
        // è‚¥æ–™ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
        function addFertilizer() {
            const nameInput = document.getElementById('fertilizerName');
            const name = nameInput.value;
            const nitrogen = parseFloat(document.getElementById('nitrogenContent').value) || 0;
            const phosphorus = parseFloat(document.getElementById('phosphorusContent').value) || 0;
            const potassium = parseFloat(document.getElementById('potassiumContent').value) || 0;
            const calcium = parseFloat(document.getElementById('calciumContent').value) || 0;
            const magnesium = parseFloat(document.getElementById('magnesiumContent').value) || 0;
            const sulfur = parseFloat(document.getElementById('sulfurContent').value) || 0;
            const iron = parseFloat(document.getElementById('ironContent').value) || 0;
            const manganese = parseFloat(document.getElementById('manganeseContent').value) || 0;
            const zinc = parseFloat(document.getElementById('zincContent').value) || 0;
            const boron = parseFloat(document.getElementById('boronContent').value) || 0;
            const other = document.getElementById('otherContent').value;
            const amountInput = document.getElementById('amount');
            let amount = parseFloat(amountInput.value) || 0;
            const unit = document.getElementById('amountUnit').value;

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—æ™‚ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            function showValidationError(element, message) {
                // å…¥åŠ›æ¬„ã‚’èµ¤ããƒã‚¤ãƒ©ã‚¤ãƒˆ
                element.style.borderColor = '#e74c3c';
                element.style.backgroundColor = 'rgba(231, 76, 60, 0.05)';
                element.style.boxShadow = '0 0 5px rgba(231, 76, 60, 0.3)';

                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                alert(message);

                // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                element.focus();

                // 3ç§’å¾Œã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤
                setTimeout(() => {
                    element.style.borderColor = '';
                    element.style.backgroundColor = '';
                    element.style.boxShadow = '';
                }, 3000);
            }

            if (!name) {
                showValidationError(nameInput, 'è‚¥æ–™åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (amount <= 0) {
                showValidationError(amountInput, 'æœ‰åŠ¹ãªä½¿ç”¨é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // æˆåŠŸæ™‚ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            const addFertilizerButton = document.querySelector('.add-fertilizer-btn');
            const originalBackground = addFertilizerButton.style.backgroundColor;

            // æˆåŠŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            addFertilizerButton.style.backgroundColor = '#27ae60';
            addFertilizerButton.style.transform = 'scale(1.05)';

            // å…ƒã«æˆ»ã™
            setTimeout(() => {
                addFertilizerButton.style.backgroundColor = originalBackground;
                addFertilizerButton.style.transform = '';
            }, 500);
            
            // kgã®å ´åˆã¯ã‚°ãƒ©ãƒ ã«å¤‰æ›
            const amountInGrams = unit === 'kg' ? amount * 1000 : amount;
            // è¡¨ç¤ºç”¨ã®å˜ä½ä»˜ãä½¿ç”¨é‡
            const displayAmount = `${amount} ${unit}`;
            
            // å„æˆåˆ†ã®å«æœ‰é‡ã‚’ã‚°ãƒ©ãƒ å˜ä½ã§è¨ˆç®—
            const nAmount = (nitrogen * amountInGrams) / 100;
            const pAmount = (phosphorus * amountInGrams) / 100;
            const kAmount = (potassium * amountInGrams) / 100;
            const caAmount = (calcium * amountInGrams) / 100;
            const mgAmount = (magnesium * amountInGrams) / 100;
            const sAmount = (sulfur * amountInGrams) / 100;
            const feAmount = (iron * amountInGrams) / 100;
            const mnAmount = (manganese * amountInGrams) / 100;
            const znAmount = (zinc * amountInGrams) / 100;
            const bAmount = (boron * amountInGrams) / 100;
            
            // è‚¥æ–™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
            const fertilizer = {
                name,
                nitrogen,
                phosphorus,
                potassium,
                calcium,
                magnesium,
                sulfur,
                iron,
                manganese,
                zinc,
                boron,
                other,
                amount: amountInGrams,
                displayAmount,
                nAmount,
                pAmount,
                kAmount,
                caAmount,
                mgAmount,
                sAmount,
                feAmount,
                mnAmount,
                znAmount,
                bAmount
            };
            
            // è‚¥æ–™ã‚’é…åˆ—ã«è¿½åŠ 
            fertilizers.push(fertilizer);
            
            // è‚¥æ–™ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            updateFertilizerList();
            
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            clearInputFields();
            
            // è‚¥æ–™ãƒªã‚¹ãƒˆã‚¿ãƒ–ã‚’è¡¨ç¤º
            switchTab('fertilizerTab');
        }
        
        // è‚¥æ–™ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateFertilizerList() {
            const fertilizerList = document.getElementById('fertilizerList');
            fertilizerList.innerHTML = '';
            
            fertilizers.forEach((fert, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${fert.name}</td>
                    <td>${fert.nitrogen.toFixed(1)}</td>
                    <td>${fert.phosphorus.toFixed(1)}</td>
                    <td>${fert.potassium.toFixed(1)}</td>
                    <td>${fert.calcium.toFixed(1)}</td>
                    <td>${fert.magnesium.toFixed(1)}</td>
                    <td>${fert.sulfur.toFixed(1)}</td>
                    <td>${fert.displayAmount}</td>
                    <td><button class="delete-btn" onclick="deleteFertilizer(${index})">å‰Šé™¤</button></td>
                `;
                
                fertilizerList.appendChild(row);
            });
        }
        
        // è‚¥æ–™ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
        function deleteFertilizer(index) {
            fertilizers.splice(index, 1);
            updateFertilizerList();
        }
        
        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
        function clearInputFields() {
            document.getElementById('fertilizerName').value = '';
            document.getElementById('nitrogenContent').value = '';
            document.getElementById('phosphorusContent').value = '';
            document.getElementById('potassiumContent').value = '';
            document.getElementById('calciumContent').value = '';
            document.getElementById('magnesiumContent').value = '';
            document.getElementById('sulfurContent').value = '';
            document.getElementById('ironContent').value = '';
            document.getElementById('manganeseContent').value = '';
            document.getElementById('zincContent').value = '';
            document.getElementById('boronContent').value = '';
            document.getElementById('otherContent').value = '';
            document.getElementById('amount').value = '';
        }
        
        // çµæœã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
        function calculateResults() {
            if (fertilizers.length === 0) {
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¦–è¦šåŠ¹æœã‚’è¿½åŠ 
                const errorMsg = document.createElement('div');
                errorMsg.innerHTML = `
                    <div style="
                        padding: 15px;
                        background-color: #ffecec;
                        color: #e74c3c;
                        border-radius: 5px;
                        text-align: center;
                        box-shadow: 0 2px 10px rgba(231, 76, 60, 0.2);
                        animation: shake 0.5s ease-in-out;
                    ">
                        <span style="font-size: 24px; margin-right: 10px;">âš ï¸</span>
                        å°‘ãªãã¨ã‚‚1ã¤ã®è‚¥æ–™ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
                    </div>
                `;

                // CSS ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¿½åŠ 
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes shake {
                        0%, 100% { transform: translateX(0); }
                        20%, 60% { transform: translateX(-10px); }
                        40%, 80% { transform: translateX(10px); }
                    }
                `;
                document.head.appendChild(style);

                // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                const resultsDiv = document.getElementById('calculationResults');
                resultsDiv.innerHTML = '';
                resultsDiv.appendChild(errorMsg);

                // çµæœã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
                switchTab('resultsTab');

                // 5ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™
                setTimeout(() => {
                    resultsDiv.innerHTML = '<p>ã¾ã è‚¥æ–™ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                }, 5000);

                return;
            }

            // è¨ˆç®—é–‹å§‹æ™‚ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            const resultsDiv = document.getElementById('calculationResults');
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="
                        width: 50px;
                        height: 50px;
                        border: 5px solid #f3f3f3;
                        border-top: 5px solid #2c7744;
                        border-radius: 50%;
                        margin: 0 auto;
                        animation: spin 1s linear infinite;
                    "></div>
                    <p style="margin-top: 15px;">è¨ˆç®—ä¸­...</p>
                </div>
            `;

            // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¿½åŠ 
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);

            // è¨ˆç®—ã‚’å°‘ã—é…å»¶ã•ã›ã¦è¦–è¦šåŠ¹æœã‚’è¦‹ã›ã‚‹
            setTimeout(() => {
                // ç·ä½¿ç”¨é‡ã¨å„è¦ç´ ã®ç·é‡ã‚’è¨ˆç®—
                const totalAmount = fertilizers.reduce((sum, fert) => sum + fert.amount, 0);
                const totalN = fertilizers.reduce((sum, fert) => sum + fert.nAmount, 0);
                const totalP = fertilizers.reduce((sum, fert) => sum + fert.pAmount, 0);
                const totalK = fertilizers.reduce((sum, fert) => sum + fert.kAmount, 0);
                const totalCa = fertilizers.reduce((sum, fert) => sum + fert.caAmount, 0);
                const totalMg = fertilizers.reduce((sum, fert) => sum + fert.mgAmount, 0);
                const totalS = fertilizers.reduce((sum, fert) => sum + fert.sAmount, 0);
                const totalFe = fertilizers.reduce((sum, fert) => sum + fert.feAmount, 0);
                const totalMn = fertilizers.reduce((sum, fert) => sum + fert.mnAmount, 0);
                const totalZn = fertilizers.reduce((sum, fert) => sum + fert.znAmount, 0);
                const totalB = fertilizers.reduce((sum, fert) => sum + fert.bAmount, 0);
            
                // æœ€çµ‚çš„ãªå«æœ‰ç‡ã‚’è¨ˆç®—
                const finalN = (totalN / totalAmount) * 100;
                const finalP = (totalP / totalAmount) * 100;
                const finalK = (totalK / totalAmount) * 100;
                const finalCa = (totalCa / totalAmount) * 100;
                const finalMg = (totalMg / totalAmount) * 100;
                const finalS = (totalS / totalAmount) * 100;
                const finalFe = (totalFe / totalAmount) * 100;
                const finalMn = (totalMn / totalAmount) * 100;
                const finalZn = (totalZn / totalAmount) * 100;
                const finalB = (totalB / totalAmount) * 100;

                // çµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                const result = {
                    totalAmount,
                    totalN,
                    totalP,
                    totalK,
                    totalCa,
                    totalMg,
                    totalS,
                    totalFe,
                    totalMn,
                    totalZn,
                    totalB,
                    finalN,
                    finalP,
                    finalK,
                    finalCa,
                    finalMg,
                    finalS,
                    finalFe,
                    finalMn,
                    finalZn,
                    finalB
                };

                // å±¥æ­´ã«è¿½åŠ 
                addToHistory(result);

                // çµæœã®HTMLä½œæˆï¼ˆã¾ã è¡¨ç¤ºã›ãšï¼‰
                const resultHTML = `
                    <div class="result-content" style="opacity: 0; transform: translateY(20px); transition: all 0.5s ease-out;">
                        <h3>ä¸»è¦æˆåˆ†</h3>
                        <table>
                            <tr>
                                <th>ç·ä½¿ç”¨é‡</th>
                                <th>çª’ç´  (N)</th>
                                <th>ãƒªãƒ³é…¸ (P)</th>
                                <th>ã‚«ãƒªã‚¦ãƒ  (K)</th>
                            </tr>
                            <tr>
                                <td>${totalAmount >= 1000 ? (totalAmount / 1000).toFixed(2) + ' kg' : totalAmount.toFixed(1) + ' g'}</td>
                                <td>${totalN.toFixed(2)} g (${finalN.toFixed(2)}%)</td>
                                <td>${totalP.toFixed(2)} g (${finalP.toFixed(2)}%)</td>
                                <td>${totalK.toFixed(2)} g (${finalK.toFixed(2)}%)</td>
                            </tr>
                        </table>

                        <h3>äºŒæ¬¡æ „é¤Šç´ </h3>
                        <table>
                            <tr>
                                <th>ã‚«ãƒ«ã‚·ã‚¦ãƒ  (Ca)</th>
                                <th>ãƒã‚°ãƒã‚·ã‚¦ãƒ  (Mg)</th>
                                <th>ç¡«é»„ (S)</th>
                            </tr>
                            <tr>
                                <td>${totalCa.toFixed(2)} g (${finalCa.toFixed(2)}%)</td>
                                <td>${totalMg.toFixed(2)} g (${finalMg.toFixed(2)}%)</td>
                                <td>${totalS.toFixed(2)} g (${finalS.toFixed(2)}%)</td>
                            </tr>
                        </table>

                        <h3>å¾®é‡æ „é¤Šç´ </h3>
                        <table>
                            <tr>
                                <th>é‰„ (Fe)</th>
                                <th>ãƒãƒ³ã‚¬ãƒ³ (Mn)</th>
                                <th>äºœé‰› (Zn)</th>
                                <th>ãƒ›ã‚¦ç´  (B)</th>
                            </tr>
                            <tr>
                                <td>${totalFe.toFixed(2)} g (${finalFe.toFixed(3)}%)</td>
                                <td>${totalMn.toFixed(2)} g (${finalMn.toFixed(3)}%)</td>
                                <td>${totalZn.toFixed(2)} g (${finalZn.toFixed(3)}%)</td>
                                <td>${totalB.toFixed(2)} g (${finalB.toFixed(3)}%)</td>
                            </tr>
                        </table>

                        <div class="npk-result" style="
                            margin-top: 20px;
                            background: linear-gradient(135deg, #e9f7ef, #d5f5e3);
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
                            transform: scale(0.95);
                            transition: all 0.3s ease;
                        ">
                            <h3 style="margin-top: 0;">æœ€çµ‚NPKæ¯”ç‡: <span style="color: #2c7744;">${finalN.toFixed(1)}-${finalP.toFixed(1)}-${finalK.toFixed(1)}</span></h3>
                        </div>

                        <p style="margin-top: 20px; font-style: italic; color: #777;">â€» æ³¨æ„: ã“ã‚Œã¯è‚¥æ–™ã®æ··åˆç·é‡é‡ã«å¯¾ã™ã‚‹å„æˆåˆ†ã®å‰²åˆã§ã™ã€‚</p>
                    </div>
                `;

                // çµæœã‚’è¡¨ç¤ºã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
                resultsDiv.innerHTML = resultHTML;

                // çµæœã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
                switchTab('resultsTab');

                // è¦ç´ ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé…å»¶ã•ã›ã¦è¡¨ç¤ºï¼‰
                setTimeout(() => {
                    const resultContent = document.querySelector('.result-content');
                    if (resultContent) {
                        resultContent.style.opacity = 1;
                        resultContent.style.transform = 'translateY(0)';

                        // NPKæ¯”ç‡ã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                        setTimeout(() => {
                            const npkResult = document.querySelector('.npk-result');
                            if (npkResult) {
                                npkResult.style.transform = 'scale(1.05)';
                                npkResult.style.boxShadow = '0 5px 15px rgba(0,0,0,0.15)';
                            }
                        }, 500);
                    }
                }, 100);
            }, 800); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’0.8ç§’è¡¨ç¤º
        }
        
        // è¨ˆç®—æ©Ÿã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
        function resetCalculator() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                fertilizers = [];
                updateFertilizerList();
                clearInputFields();
                document.getElementById('calculationResults').innerHTML = '<p>ã¾ã è‚¥æ–™ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
            }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const modal = document.getElementById('presetsModal');
            if (event.target === modal) {
                closePresetsModal();
            }
        };

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–: UIåŠ¹æœã¨ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œã®åˆæœŸåŒ–
            initMobileSupport();
            // UI: ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹éš›ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabContents = document.querySelectorAll('.tab-content');
                    tabContents.forEach(content => {
                        content.style.animation = 'none';
                        content.offsetHeight; // ãƒªãƒ•ãƒ­ãƒ¼ï¼ˆå†æç”»ï¼‰ã‚’ãƒˆãƒªã‚¬ãƒ¼
                        content.style.animation = null;
                    });
                });

                // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£: ã‚¿ãƒ–ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
                tab.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                        e.preventDefault();
                        const allTabs = Array.from(document.querySelectorAll('.tab'));
                        const currentIndex = allTabs.indexOf(this);
                        let nextIndex;

                        if (e.key === 'ArrowLeft') {
                            nextIndex = currentIndex > 0 ? currentIndex - 1 : allTabs.length - 1;
                        } else {
                            nextIndex = currentIndex < allTabs.length - 1 ? currentIndex + 1 : 0;
                        }

                        allTabs[nextIndex].focus();
                    }
                });
            });

            // UI: ãƒœã‚¿ãƒ³ã®ãƒªãƒƒãƒ—ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function(e) {
                    // ãƒªãƒƒãƒ—ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®è¦ç´ ã‚’ä½œæˆ
                    const ripple = document.createElement('span');
                    this.appendChild(ripple);

                    // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã‚’å–å¾—
                    const x = e.clientX - this.getBoundingClientRect().left;
                    const y = e.clientY - this.getBoundingClientRect().top;

                    // ãƒªãƒƒãƒ—ãƒ«ã®ä½ç½®ã‚’è¨­å®š
                    ripple.style.cssText = `
                        position: absolute;
                        background-color: rgba(255, 255, 255, 0.5);
                        border-radius: 50%;
                        width: 5px;
                        height: 5px;
                        top: ${y}px;
                        left: ${x}px;
                        transform: scale(0);
                        transition: transform 0.5s, opacity 0.5s;
                        pointer-events: none;
                    `;

                    // ãƒªãƒƒãƒ—ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    setTimeout(() => {
                        ripple.style.transform = 'scale(50)';
                        ripple.style.opacity = '0';

                        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«è¦ç´ ã‚’å‰Šé™¤
                        setTimeout(() => {
                            ripple.remove();
                        }, 500);
                    }, 10);
                });

                // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¼·åŒ–
                if (button.classList.contains('delete-btn') && !button.hasAttribute('aria-label')) {
                    button.setAttribute('aria-label', 'å‰Šé™¤');
                }
            });

            // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£: åˆæœŸã‚¿ãƒ–ã®è¨­å®š
            const activeTabs = document.querySelectorAll('.tab.active');
            activeTabs.forEach(tab => {
                tab.setAttribute('aria-selected', 'true');
            });

            // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£: åˆæœŸã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¨­å®š
            const initialActiveContents = document.querySelectorAll('.tab-content.active');
            initialActiveContents.forEach(content => {
                content.removeAttribute('hidden');
                content.setAttribute('aria-hidden', 'false');
            });

            const inactiveContents = document.querySelectorAll('.tab-content:not(.active)');
            inactiveContents.forEach(content => {
                content.setAttribute('hidden', 'true');
                content.setAttribute('aria-hidden', 'true');
            });

            // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£: é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
            if (!document.getElementById('accessibility-announcer')) {
                const announcer = document.createElement('div');
                announcer.id = 'accessibility-announcer';
                announcer.className = 'visually-hidden';
                announcer.setAttribute('role', 'status');
                announcer.setAttribute('aria-live', 'polite');
                document.body.appendChild(announcer);
            }

            // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£: é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ¤œå‡º
            function checkHighContrastMode() {
                const highContrastStyle = document.createElement('div');
                highContrastStyle.style.color = 'canvastext';
                highContrastStyle.style.backgroundColor = 'canvas';
                document.body.appendChild(highContrastStyle);

                const computedStyle = getComputedStyle(highContrastStyle);
                const isHighContrast =
                    computedStyle.backgroundColor === 'rgb(255, 255, 255)' &&
                    computedStyle.color === 'rgb(0, 0, 0)';

                document.body.removeChild(highContrastStyle);

                if (isHighContrast) {
                    document.body.classList.add('high-contrast-mode');
                }
            }

            // é«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ¤œå‡ºã‚’å®Ÿè¡Œ
            checkHighContrastMode();

            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®šã®åˆæœŸåŒ–
            initThemeToggle();
        });

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function initThemeToggle() {
            const themeToggleBtn = document.getElementById('themeToggle');

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’èª­ã¿è¾¼ã‚€
            const userPrefersDark = localStorage.getItem('darkMode') === 'true';

            // OSã®è¨­å®šã‚’ãƒã‚§ãƒƒã‚¯
            const systemPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚’é©ç”¨ã™ã¹ãã‹æ±ºå®š
            const shouldApplyDark = userPrefersDark !== null ? userPrefersDark : systemPrefersDark;

            // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
            if (shouldApplyDark) {
                document.body.classList.add('dark-mode');
                themeToggleBtn.innerText = 'ğŸŒ'; // å¤ªé™½ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆæ˜ã‚‹ãã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            } else {
                themeToggleBtn.innerText = 'ğŸŒ™'; // æœˆã‚¢ã‚¤ã‚³ãƒ³ï¼ˆæš—ãã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            }

            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
            themeToggleBtn.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');

                // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‹ã©ã†ã‹ã®æ–°ã—ã„çŠ¶æ…‹
                const isDarkMode = document.body.classList.contains('dark-mode');

                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«è¨­å®šã‚’ä¿å­˜
                localStorage.setItem('darkMode', isDarkMode);

                // ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
                themeToggleBtn.innerText = isDarkMode ? 'ğŸŒ' : 'ğŸŒ™';

                // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ç”¨ã®é€šçŸ¥
                const modeAnnouncer = document.createElement('div');
                modeAnnouncer.className = 'visually-hidden';
                modeAnnouncer.setAttribute('role', 'status');
                modeAnnouncer.setAttribute('aria-live', 'polite');
                modeAnnouncer.textContent = isDarkMode ? 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ' : 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ';
                document.body.appendChild(modeAnnouncer);

                // é€šçŸ¥ã‚’ä¸€å®šæ™‚é–“å¾Œã«å‰Šé™¤
                setTimeout(() => {
                    document.body.removeChild(modeAnnouncer);
                }, 1000);
            });

            // OSè¨­å®šã®å¤‰æ›´ã‚’ç›£è¦–
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºçš„ã«è¨­å®šã—ã¦ã„ãªã„å ´åˆã®ã¿OSã®è¨­å®šã«å¾“ã†
                    if (localStorage.getItem('darkMode') === null) {
                        const shouldBeDark = event.matches;
                        document.body.classList.toggle('dark-mode', shouldBeDark);
                        themeToggleBtn.innerText = shouldBeDark ? 'ğŸŒ' : 'ğŸŒ™';
                    }
                });
            }
        }

        // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹å‘ã‘ã®æœ€é©åŒ–
        function initMobileSupport() {
            // iOSã§ã®ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            // FastClickã®å®Ÿè£…ï¼ˆã‚¿ãƒƒãƒ—ã®é…å»¶ã‚’è§£æ¶ˆï¼‰
            const attachFastClick = function() {
                const touchElements = document.querySelectorAll('button, .preset-btn, .tab');
                touchElements.forEach(el => {
                    let touchStartTime = 0;
                    let touchStartX = 0;
                    let touchStartY = 0;

                    el.addEventListener('touchstart', function(e) {
                        touchStartTime = Date.now();
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                    }, { passive: true });

                    el.addEventListener('touchend', function(e) {
                        const touchTime = Date.now() - touchStartTime;
                        const touchEndX = e.changedTouches[0].clientX;
                        const touchEndY = e.changedTouches[0].clientY;
                        const touchDistance = Math.sqrt(
                            Math.pow(touchEndX - touchStartX, 2) +
                            Math.pow(touchEndY - touchStartY, 2)
                        );

                        // çŸ­æ™‚é–“ã‚¿ãƒƒãƒ—ã‹ã¤ç§»å‹•è·é›¢ãŒå°‘ãªã„å ´åˆã«ã®ã¿ã‚¯ãƒªãƒƒã‚¯ã¨åˆ¤å®š
                        if (touchTime < 300 && touchDistance < 10) {
                            e.preventDefault();
                            const clickEvent = new MouseEvent('click', {
                                view: window,
                                bubbles: true,
                                cancelable: true
                            });
                            el.dispatchEvent(clickEvent);
                        }
                    });
                });
            };

            // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®æ¤œå‡º
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (isMobile) {
                attachFastClick();

                // ã‚¹ãƒ¯ã‚¤ãƒ—ãƒ’ãƒ³ãƒˆã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                const swipeHints = document.querySelectorAll('.mobile-swipe-hint');
                swipeHints.forEach(hint => {
                    hint.style.display = 'block';
                });

                // ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’åˆ†ã‹ã‚Šã‚„ã™ã
                const tableContainers = document.querySelectorAll('.table-responsive');
                tableContainers.forEach(container => {
                    container.addEventListener('scroll', function() {
                        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸã‚‰ãƒ’ãƒ³ãƒˆã‚’éš ã™
                        const hint = container.parentNode.querySelector('.mobile-swipe-hint');
                        if (hint) {
                            setTimeout(() => {
                                hint.style.opacity = '0';
                                setTimeout(() => {
                                    hint.style.display = 'none';
                                }, 500);
                            }, 1000);
                        }
                    });
                });

                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ãŸã¨ãã€ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã‚’èª¿æ•´
                const inputFields = document.querySelectorAll('input, select');
                inputFields.forEach(field => {
                    field.addEventListener('focus', function() {
                        // ãƒ¢ãƒã‚¤ãƒ«ã§ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚ŒãŸã¨ãã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’èª¿æ•´
                        setTimeout(() => {
                            field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    });
                });
            }
        }
    </script>
</body>
</html>